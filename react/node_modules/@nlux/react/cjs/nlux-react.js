"use strict";var e=require("react"),t=require("@nlux/core"),r=require("react-dom"),n=Object.prototype.hasOwnProperty;function o(e,t,r){for(r of e.keys())if(i(r,t))return r}function i(e,t){var r,s,u;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return e.toString()===t.toString();if(r===Array){if((s=e.length)===t.length)for(;s--&&i(e[s],t[s]););return-1===s}if(r===Set){if(e.size!==t.size)return!1;for(s of e){if((u=s)&&"object"==typeof u&&!(u=o(t,u)))return!1;if(!t.has(u))return!1}return!0}if(r===Map){if(e.size!==t.size)return!1;for(s of e){if((u=s[0])&&"object"==typeof u&&!(u=o(t,u)))return!1;if(!i(s[1],t.get(u)))return!1}return!0}if(r===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(r===DataView){if((s=e.byteLength)===t.byteLength)for(;s--&&e.getInt8(s)===t.getInt8(s););return-1===s}if(ArrayBuffer.isView(e)){if((s=e.byteLength)===t.byteLength)for(;s--&&e[s]===t[s];);return-1===s}if(!r||"object"==typeof e){for(r in s=0,e){if(n.call(e,r)&&++s&&!n.call(t,r))return!1;if(!(r in t)||!i(e[r],t[r]))return!1}return Object.keys(t).length===s}}return e!=e&&t!=t}const s=e=>new Promise((t=>{const n=document.createElement("div");r.render(e,n,(()=>{if(1!==n.children.length||!n.firstElementChild)throw new Error("Expected exactly one child");t(n.firstElementChild)}))})),u=async e=>{const[t,r]=await Promise.all([(async()=>{if(!e.bot)return;const t="string"==typeof e.bot.picture?e.bot.picture:await s(e.bot.picture);return{name:e.bot.name,tagline:e.bot.tagline,picture:t}})(),(async()=>{if(!e.user)return;const t="string"==typeof e.user.picture?e.user.picture:await s(e.user.picture);return{name:e.user.name,picture:t}})()]);return{bot:t,user:r}},a=(e,t)=>{if(void 0===e&&void 0===t)return;if(void 0!==e&&void 0===t){const t={},r=Object.keys(e);for(const e of r)t[e]=void 0;return t}if(void 0===e&&void 0!==t)return t;if(!t||!e)return;let r=!1;const n={},o=Object.keys(t);for(const i of o)e[i]!==t[i]&&(n[i]=t[i],r=!0);return r?n:void 0},c=async(e,r)=>{const n=a(e.events,r.events),o=a(e.layoutOptions,r.layoutOptions),i=a(e.conversationOptions,r.conversationOptions),s=a(e.promptBoxOptions,r.promptBoxOptions),c=await(async(e,t)=>{const r={};if((void 0!==e||void 0!==t)&&(e?.bot!==t?.bot&&(r.bot=void 0===t?.bot?void 0:(await u({bot:t.bot})).bot),e?.user!==t?.user&&(r.user=void 0===t?.user?void 0:(await u({user:t.user})).user),0!==Object.keys(r).length))return r})(e.personaOptions,r.personaOptions),f={};void 0!==n&&(f.events=n??{}),void 0!==o&&(f.layoutOptions=o??{}),void 0!==i&&(f.conversationOptions=i??{}),void 0!==s&&(f.promptBoxOptions=s??{}),void 0!==c&&(f.personaOptions=c??{});const l=e.adapter!==r.adapter?r.adapter:void 0;if(void 0!==l){const e=(e=>{let r="unknown";const n=e;if("function"==typeof n?.create)r="builder";else if("function"==typeof n?.fetchText||"function"==typeof n?.streamText)return r="instance",e;if("unknown"!==r){if("builder"===r){const e=n.create();return"function"==typeof e?.fetchText||"function"==typeof e?.streamText?e:void t.warn("The adapter builder did not return a valid adapter.")}return e}t.warn("Unable to determine the type of the adapter.")})(l);e?f.adapter=e:t.warn({message:"Invalid new adapter property provided! The adapter must be an instance of ChatAdapter or ChatAdapterBuilder.",type:"invalid-adapter"})}e.className!==r.className&&(f.className=r.className),e.syntaxHighlighter!==r.syntaxHighlighter&&(f.syntaxHighlighter=r.syntaxHighlighter);if(Object.keys(f).length>0)return f},f=function(t,r){return e.useEffect(t,function(t){const r=e.useRef(t),n=e.useRef(0);return i(t,r.current)||(r.current=t,n.current+=1),e.useMemo((()=>r.current),[n.current])}(r))};Object.defineProperty(exports,"NluxConfigError",{enumerable:!0,get:function(){return t.NluxConfigError}}),Object.defineProperty(exports,"NluxError",{enumerable:!0,get:function(){return t.NluxError}}),Object.defineProperty(exports,"NluxRenderingError",{enumerable:!0,get:function(){return t.NluxRenderingError}}),Object.defineProperty(exports,"NluxUsageError",{enumerable:!0,get:function(){return t.NluxUsageError}}),Object.defineProperty(exports,"NluxValidationError",{enumerable:!0,get:function(){return t.NluxValidationError}}),Object.defineProperty(exports,"debug",{enumerable:!0,get:function(){return t.debug}}),exports.AiChat=r=>{const n=e.useRef(null),[o,i]=e.useState(null),s=e.useRef(null);return e.useEffect((()=>{if(!n.current)throw new Error("Root element is not defined");let e=!0;const{adapter:o,className:i,syntaxHighlighter:a,layoutOptions:c,conversationOptions:f,promptBoxOptions:l,personaOptions:p,events:d,initialConversation:h}=r;let m=t.createAiChat().withAdapter(o);if(c&&(m=m.withLayoutOptions(c)),l&&(m=m.withPromptBoxOptions(l)),f&&(m=m.withConversationOptions(f)),i&&(m=m.withClassName(i)),a&&(m=m.withSyntaxHighlighter(a)),h&&(m=m.withInitialConversation(h)),d){const e=Object.keys(d);for(const t of e){const e=d[t];e&&m.on(t,e)}}return p?u(p).then((r=>{m=m.withPersonaOptions(r),e&&(n.current?(m.mount(n.current),s.current=m):t.warn("Root element is not defined! AiChat cannot be mounted."))})):(m.mount(n.current),s.current=m),()=>{e=!1,m?.unmount()}}),[]),e.useEffect((()=>{let e=!1;if(o)return s.current&&c(o,r).then((n=>{!e&&n&&(s.current?(s.current.updateProps(n),i(r)):t.warn("AiChat is not defined! Cannot update."))})),()=>{e=!0};i(r)}),[r,o]),e.createElement("div",{ref:n})},exports.createAiContext=r=>{const n=t.createAiContext(),o=e.createContext(n);return{Provider:n=>{const[i,s]=e.useState(),[u,a]=e.useState(),[c,f]=e.useState();e.useEffect((()=>{let e=!0;const o=t.createAiContext().withAdapter(r).withDataSyncOptions({syncStrategy:"auto",contextSize:t.predefinedContextSize["100k"]});return f(o),o.initialize(n.initialItems||{}).then((t=>{e&&(t.success?s(t.contextId):a(new Error(t.error)))})),()=>{e=!1,o.destroy()}}),[]);const{children:l}=n;return u?n.errorComponent?e.createElement(n.errorComponent,{error:u.message}):e.createElement("div",null,e.createElement("h1",null,"Error initializing AI context"),e.createElement("p",null,u.message)):i&&c?e.createElement(o.Provider,{value:c},l):n.loadingComponent?e.createElement(n.loadingComponent,null):null},ref:o}},exports.useAiContext=(t,r,n)=>{const o=e.useContext(t.ref),[i]=e.useState((()=>{let e;do{e=Math.random().toString(36).substring(2,15)}while(o.hasItem(e));return e})),s=e.useRef();e.useEffect((()=>(s.current=o.observeState(i,r,n),()=>{s.current?.discard(),s.current=void 0})),[]),e.useEffect((()=>{s.current?.setDescription(r)}),[r]),e.useEffect((()=>{s.current?.setData(n)}),[n])},exports.useAiTask=(t,r,n,o)=>{const i=e.useContext(t.ref),[s]=e.useState((()=>{let e;do{e=Math.random().toString(36).substring(2,15)}while(i.hasTask(e));return e})),u=e.useRef();e.useEffect((()=>(u.current=i.registerTask(s,r,n,o),()=>{u.current?.discard(),u.current=void 0})),[]),e.useEffect((()=>{u.current?.setDescription(r)}),[r]),e.useEffect((()=>{u.current?.setCallback(n)}),[n]),e.useEffect((()=>{u.current?.setParamDescriptions(o??[])}),[o])},exports.useDeepCompareEffect=f;
