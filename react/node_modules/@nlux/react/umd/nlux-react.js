!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("@nlux/core"),require("react-dom")):"function"==typeof define&&define.amd?define(["exports","react","@nlux/core","react-dom"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@nlux/react"]={},e.React,e.core,e.reactDom)}(this,(function(e,t,r,n){"use strict";var o=Object.prototype.hasOwnProperty;function i(e,t,r){for(r of e.keys())if(u(r,t))return r}function u(e,t){var r,n,s;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return e.toString()===t.toString();if(r===Array){if((n=e.length)===t.length)for(;n--&&u(e[n],t[n]););return-1===n}if(r===Set){if(e.size!==t.size)return!1;for(n of e){if((s=n)&&"object"==typeof s&&!(s=i(t,s)))return!1;if(!t.has(s))return!1}return!0}if(r===Map){if(e.size!==t.size)return!1;for(n of e){if((s=n[0])&&"object"==typeof s&&!(s=i(t,s)))return!1;if(!u(n[1],t.get(s)))return!1}return!0}if(r===ArrayBuffer)e=new Uint8Array(e),t=new Uint8Array(t);else if(r===DataView){if((n=e.byteLength)===t.byteLength)for(;n--&&e.getInt8(n)===t.getInt8(n););return-1===n}if(ArrayBuffer.isView(e)){if((n=e.byteLength)===t.byteLength)for(;n--&&e[n]===t[n];);return-1===n}if(!r||"object"==typeof e){for(r in n=0,e){if(o.call(e,r)&&++n&&!o.call(t,r))return!1;if(!(r in t)||!u(e[r],t[r]))return!1}return Object.keys(t).length===n}}return e!=e&&t!=t}const s=e=>new Promise((t=>{const r=document.createElement("div");n.render(e,r,(()=>{if(1!==r.children.length||!r.firstElementChild)throw new Error("Expected exactly one child");t(r.firstElementChild)}))})),a=async e=>{const[t,r]=await Promise.all([(async()=>{if(!e.bot)return;const t="string"==typeof e.bot.picture?e.bot.picture:await s(e.bot.picture);return{name:e.bot.name,tagline:e.bot.tagline,picture:t}})(),(async()=>{if(!e.user)return;const t="string"==typeof e.user.picture?e.user.picture:await s(e.user.picture);return{name:e.user.name,picture:t}})()]);return{bot:t,user:r}},c=(e,t)=>{if(void 0===e&&void 0===t)return;if(void 0!==e&&void 0===t){const t={},r=Object.keys(e);for(const e of r)t[e]=void 0;return t}if(void 0===e&&void 0!==t)return t;if(!t||!e)return;let r=!1;const n={},o=Object.keys(t);for(const i of o)e[i]!==t[i]&&(n[i]=t[i],r=!0);return r?n:void 0},f=async(e,t)=>{const n=c(e.events,t.events),o=c(e.layoutOptions,t.layoutOptions),i=c(e.conversationOptions,t.conversationOptions),u=c(e.promptBoxOptions,t.promptBoxOptions),s=await(async(e,t)=>{const r={};if((void 0!==e||void 0!==t)&&(e?.bot!==t?.bot&&(r.bot=void 0===t?.bot?void 0:(await a({bot:t.bot})).bot),e?.user!==t?.user&&(r.user=void 0===t?.user?void 0:(await a({user:t.user})).user),0!==Object.keys(r).length))return r})(e.personaOptions,t.personaOptions),f={};void 0!==n&&(f.events=n??{}),void 0!==o&&(f.layoutOptions=o??{}),void 0!==i&&(f.conversationOptions=i??{}),void 0!==u&&(f.promptBoxOptions=u??{}),void 0!==s&&(f.personaOptions=s??{});const l=e.adapter!==t.adapter?t.adapter:void 0;if(void 0!==l){const e=(e=>{let t="unknown";const n=e;if("function"==typeof n?.create)t="builder";else if("function"==typeof n?.fetchText||"function"==typeof n?.streamText)return t="instance",e;if("unknown"!==t){if("builder"===t){const e=n.create();return"function"==typeof e?.fetchText||"function"==typeof e?.streamText?e:void r.warn("The adapter builder did not return a valid adapter.")}return e}r.warn("Unable to determine the type of the adapter.")})(l);e?f.adapter=e:r.warn({message:"Invalid new adapter property provided! The adapter must be an instance of ChatAdapter or ChatAdapterBuilder.",type:"invalid-adapter"})}e.className!==t.className&&(f.className=t.className),e.syntaxHighlighter!==t.syntaxHighlighter&&(f.syntaxHighlighter=t.syntaxHighlighter);if(Object.keys(f).length>0)return f},l=function(e,r){return t.useEffect(e,function(e){const r=t.useRef(e),n=t.useRef(0);return u(e,r.current)||(r.current=e,n.current+=1),t.useMemo((()=>r.current),[n.current])}(r))};Object.defineProperty(e,"NluxConfigError",{enumerable:!0,get:function(){return r.NluxConfigError}}),Object.defineProperty(e,"NluxError",{enumerable:!0,get:function(){return r.NluxError}}),Object.defineProperty(e,"NluxRenderingError",{enumerable:!0,get:function(){return r.NluxRenderingError}}),Object.defineProperty(e,"NluxUsageError",{enumerable:!0,get:function(){return r.NluxUsageError}}),Object.defineProperty(e,"NluxValidationError",{enumerable:!0,get:function(){return r.NluxValidationError}}),Object.defineProperty(e,"debug",{enumerable:!0,get:function(){return r.debug}}),e.AiChat=e=>{const n=t.useRef(null),[o,i]=t.useState(null),u=t.useRef(null);return t.useEffect((()=>{if(!n.current)throw new Error("Root element is not defined");let t=!0;const{adapter:o,className:i,syntaxHighlighter:s,layoutOptions:c,conversationOptions:f,promptBoxOptions:l,personaOptions:d,events:p,initialConversation:h}=e;let m=r.createAiChat().withAdapter(o);if(c&&(m=m.withLayoutOptions(c)),l&&(m=m.withPromptBoxOptions(l)),f&&(m=m.withConversationOptions(f)),i&&(m=m.withClassName(i)),s&&(m=m.withSyntaxHighlighter(s)),h&&(m=m.withInitialConversation(h)),p){const e=Object.keys(p);for(const t of e){const e=p[t];e&&m.on(t,e)}}return d?a(d).then((e=>{m=m.withPersonaOptions(e),t&&(n.current?(m.mount(n.current),u.current=m):r.warn("Root element is not defined! AiChat cannot be mounted."))})):(m.mount(n.current),u.current=m),()=>{t=!1,m?.unmount()}}),[]),t.useEffect((()=>{let t=!1;if(o)return u.current&&f(o,e).then((n=>{!t&&n&&(u.current?(u.current.updateProps(n),i(e)):r.warn("AiChat is not defined! Cannot update."))})),()=>{t=!0};i(e)}),[e,o]),t.createElement("div",{ref:n})},e.createAiContext=e=>{const n=r.createAiContext(),o=t.createContext(n);return{Provider:n=>{const[i,u]=t.useState(),[s,a]=t.useState(),[c,f]=t.useState();t.useEffect((()=>{let t=!0;const o=r.createAiContext().withAdapter(e).withDataSyncOptions({syncStrategy:"auto",contextSize:r.predefinedContextSize["100k"]});return f(o),o.initialize(n.initialItems||{}).then((e=>{t&&(e.success?u(e.contextId):a(new Error(e.error)))})),()=>{t=!1,o.destroy()}}),[]);const{children:l}=n;return s?n.errorComponent?t.createElement(n.errorComponent,{error:s.message}):t.createElement("div",null,t.createElement("h1",null,"Error initializing AI context"),t.createElement("p",null,s.message)):i&&c?t.createElement(o.Provider,{value:c},l):n.loadingComponent?t.createElement(n.loadingComponent,null):null},ref:o}},e.useAiContext=(e,r,n)=>{const o=t.useContext(e.ref),[i]=t.useState((()=>{let e;do{e=Math.random().toString(36).substring(2,15)}while(o.hasItem(e));return e})),u=t.useRef();t.useEffect((()=>(u.current=o.observeState(i,r,n),()=>{u.current?.discard(),u.current=void 0})),[]),t.useEffect((()=>{u.current?.setDescription(r)}),[r]),t.useEffect((()=>{u.current?.setData(n)}),[n])},e.useAiTask=(e,r,n,o)=>{const i=t.useContext(e.ref),[u]=t.useState((()=>{let e;do{e=Math.random().toString(36).substring(2,15)}while(i.hasTask(e));return e})),s=t.useRef();t.useEffect((()=>(s.current=i.registerTask(u,r,n,o),()=>{s.current?.discard(),s.current=void 0})),[]),t.useEffect((()=>{s.current?.setDescription(r)}),[r]),t.useEffect((()=>{s.current?.setCallback(n)}),[n]),t.useEffect((()=>{s.current?.setParamDescriptions(o??[])}),[o])},e.useDeepCompareEffect=l}));
