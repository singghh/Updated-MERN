import t,{useEffect as e,useRef as r,useMemo as n,useState as o,useContext as i,createContext as a}from"react";import{warn as s,createAiChat as u,createAiContext as c,predefinedContextSize as l}from"@nlux/core";export{NluxConfigError,NluxError,NluxRenderingError,NluxUsageError,NluxValidationError,debug}from"@nlux/core";import{render as f}from"react-dom";var p=Object.prototype.hasOwnProperty;function d(t,e,r){for(r of t.keys())if(h(r,e))return r}function h(t,e){var r,n,o;if(t===e)return!0;if(t&&e&&(r=t.constructor)===e.constructor){if(r===Date)return t.getTime()===e.getTime();if(r===RegExp)return t.toString()===e.toString();if(r===Array){if((n=t.length)===e.length)for(;n--&&h(t[n],e[n]););return-1===n}if(r===Set){if(t.size!==e.size)return!1;for(n of t){if((o=n)&&"object"==typeof o&&!(o=d(e,o)))return!1;if(!e.has(o))return!1}return!0}if(r===Map){if(t.size!==e.size)return!1;for(n of t){if((o=n[0])&&"object"==typeof o&&!(o=d(e,o)))return!1;if(!h(n[1],e.get(o)))return!1}return!0}if(r===ArrayBuffer)t=new Uint8Array(t),e=new Uint8Array(e);else if(r===DataView){if((n=t.byteLength)===e.byteLength)for(;n--&&t.getInt8(n)===e.getInt8(n););return-1===n}if(ArrayBuffer.isView(t)){if((n=t.byteLength)===e.byteLength)for(;n--&&t[n]===e[n];);return-1===n}if(!r||"object"==typeof t){for(r in n=0,t){if(p.call(t,r)&&++n&&!p.call(e,r))return!1;if(!(r in e)||!h(t[r],e[r]))return!1}return Object.keys(e).length===n}}return t!=t&&e!=e}const m=t=>new Promise((e=>{const r=document.createElement("div");f(t,r,(()=>{if(1!==r.children.length||!r.firstElementChild)throw new Error("Expected exactly one child");e(r.firstElementChild)}))})),y=async t=>{const[e,r]=await Promise.all([(async()=>{if(!t.bot)return;const e="string"==typeof t.bot.picture?t.bot.picture:await m(t.bot.picture);return{name:t.bot.name,tagline:t.bot.tagline,picture:e}})(),(async()=>{if(!t.user)return;const e="string"==typeof t.user.picture?t.user.picture:await m(t.user.picture);return{name:t.user.name,picture:e}})()]);return{bot:e,user:r}},g=(t,e)=>{if(void 0===t&&void 0===e)return;if(void 0!==t&&void 0===e){const e={},r=Object.keys(t);for(const t of r)e[t]=void 0;return e}if(void 0===t&&void 0!==e)return e;if(!e||!t)return;let r=!1;const n={},o=Object.keys(e);for(const i of o)t[i]!==e[i]&&(n[i]=e[i],r=!0);return r?n:void 0},v=async(t,e)=>{const r=g(t.events,e.events),n=g(t.layoutOptions,e.layoutOptions),o=g(t.conversationOptions,e.conversationOptions),i=g(t.promptBoxOptions,e.promptBoxOptions),a=await(async(t,e)=>{const r={};if((void 0!==t||void 0!==e)&&(t?.bot!==e?.bot&&(r.bot=void 0===e?.bot?void 0:(await y({bot:e.bot})).bot),t?.user!==e?.user&&(r.user=void 0===e?.user?void 0:(await y({user:e.user})).user),0!==Object.keys(r).length))return r})(t.personaOptions,e.personaOptions),u={};void 0!==r&&(u.events=r??{}),void 0!==n&&(u.layoutOptions=n??{}),void 0!==o&&(u.conversationOptions=o??{}),void 0!==i&&(u.promptBoxOptions=i??{}),void 0!==a&&(u.personaOptions=a??{});const c=t.adapter!==e.adapter?e.adapter:void 0;if(void 0!==c){const t=(t=>{let e="unknown";const r=t;if("function"==typeof r?.create)e="builder";else if("function"==typeof r?.fetchText||"function"==typeof r?.streamText)return e="instance",t;if("unknown"!==e){if("builder"===e){const t=r.create();return"function"==typeof t?.fetchText||"function"==typeof t?.streamText?t:void s("The adapter builder did not return a valid adapter.")}return t}s("Unable to determine the type of the adapter.")})(c);t?u.adapter=t:s({message:"Invalid new adapter property provided! The adapter must be an instance of ChatAdapter or ChatAdapterBuilder.",type:"invalid-adapter"})}t.className!==e.className&&(u.className=e.className),t.syntaxHighlighter!==e.syntaxHighlighter&&(u.syntaxHighlighter=e.syntaxHighlighter);if(Object.keys(u).length>0)return u},b=n=>{const i=r(null),[a,c]=o(null),l=r(null);return e((()=>{if(!i.current)throw new Error("Root element is not defined");let t=!0;const{adapter:e,className:r,syntaxHighlighter:o,layoutOptions:a,conversationOptions:c,promptBoxOptions:f,personaOptions:p,events:d,initialConversation:h}=n;let m=u().withAdapter(e);if(a&&(m=m.withLayoutOptions(a)),f&&(m=m.withPromptBoxOptions(f)),c&&(m=m.withConversationOptions(c)),r&&(m=m.withClassName(r)),o&&(m=m.withSyntaxHighlighter(o)),h&&(m=m.withInitialConversation(h)),d){const t=Object.keys(d);for(const e of t){const t=d[e];t&&m.on(e,t)}}return p?y(p).then((e=>{m=m.withPersonaOptions(e),t&&(i.current?(m.mount(i.current),l.current=m):s("Root element is not defined! AiChat cannot be mounted."))})):(m.mount(i.current),l.current=m),()=>{t=!1,m?.unmount()}}),[]),e((()=>{let t=!1;if(a)return l.current&&v(a,n).then((e=>{!t&&e&&(l.current?(l.current.updateProps(e),c(n)):s("AiChat is not defined! Cannot update."))})),()=>{t=!0};c(n)}),[n,a]),t.createElement("div",{ref:i})},w=(t,n,a)=>{const s=i(t.ref),[u]=o((()=>{let t;do{t=Math.random().toString(36).substring(2,15)}while(s.hasItem(t));return t})),c=r();e((()=>(c.current=s.observeState(u,n,a),()=>{c.current?.discard(),c.current=void 0})),[]),e((()=>{c.current?.setDescription(n)}),[n]),e((()=>{c.current?.setData(a)}),[a])},x=(t,n,a,s)=>{const u=i(t.ref),[c]=o((()=>{let t;do{t=Math.random().toString(36).substring(2,15)}while(u.hasTask(t));return t})),l=r();e((()=>(l.current=u.registerTask(c,n,a,s),()=>{l.current?.discard(),l.current=void 0})),[]),e((()=>{l.current?.setDescription(n)}),[n]),e((()=>{l.current?.setCallback(a)}),[a]),e((()=>{l.current?.setParamDescriptions(s??[])}),[s])},O=r=>{const n=c(),o=a(n);return{Provider:n=>{const[i,a]=t.useState(),[s,u]=t.useState(),[f,p]=t.useState();e((()=>{let t=!0;const e=c().withAdapter(r).withDataSyncOptions({syncStrategy:"auto",contextSize:l["100k"]});return p(e),e.initialize(n.initialItems||{}).then((e=>{t&&(e.success?a(e.contextId):u(new Error(e.error)))})),()=>{t=!1,e.destroy()}}),[]);const{children:d}=n;return s?n.errorComponent?t.createElement(n.errorComponent,{error:s.message}):t.createElement("div",null,t.createElement("h1",null,"Error initializing AI context"),t.createElement("p",null,s.message)):i&&f?t.createElement(o.Provider,{value:f},d):n.loadingComponent?t.createElement(n.loadingComponent,null):null},ref:o}},E=function(t,o){return e(t,function(t){const e=r(t),o=r(0);return h(t,e.current)||(e.current=t,o.current+=1),n((()=>e.current),[o.current])}(o))};export{b as AiChat,O as createAiContext,w as useAiContext,x as useAiTask,E as useDeepCompareEffect};
