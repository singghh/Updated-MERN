!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@nlux/core"]={})}(this,(function(e){"use strict";const t=e=>{"string"!=typeof e?e&&"function"==typeof e.toString?console.warn(`[nlux] ${e.toString()}`):console.warn("[nlux]"):console.warn(`[nlux] ${e}`)},s=[],n=e=>{s.includes(e)||(s.push(e),t(e))},o=class e{constructor(){}static register(s){const n=s.__compId;n?void 0===e.componentDefs.get(n)&&(s.__renderer&&s.__updater?e.componentDefs.set(n,{id:n,model:s,render:s.__renderer,update:s.__updater}):t(`Component with id "${n}" missing renderer or updater`)):t("Component definition missing valid id")}static retrieve(s){const n=e.componentDefs.get(s);if(n)return n;t(`Component with id "${s}" not registered`)}};o.componentDefs=new Map;let r=o;const i={version:"{versions.nlux}",[btoa("componentsRegistered")]:!1},a=()=>{if("undefined"==typeof window)return;const e=window;return"object"==typeof e.nlux&&"string"==typeof e.nlux.version?e.nlux:(window.nlux=i,i)},d=e=>{const t=requestAnimationFrame((()=>{e()}));return()=>{cancelAnimationFrame(t)}},c=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{let t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));class h extends Error{constructor(e={}){super(e.message),this.message=e.message??"",this.source=e.source,this.type=this.constructor.name,this.exceptionId=e.exceptionId}}class l extends h{}class u extends h{}class p extends h{}class m{constructor(e,s){this.subComponentElementIds=new Map,this.subComponents=new Map,this.__context=null,this.__destroyed=!1,this.actionsOnDomReady=[],this.compEventGetter=e=>{const t=this.rendererEventListeners.get(e);if(!t)throw new h({source:this.constructor.name,message:`Unable to call renderer event "${e}" because no matching event listener was found. Make sure that the event listener is registered using @CompEventListener() decorator in the component model class, and use class methods instead of arrow function attributes.`});return t};const n=Object.getPrototypeOf(this).constructor.__compId;if(!n)throw new l({source:this.constructor.name,message:"Unable to instantiate component: missing compId in implementation. Component should be annotated using @Model() to set compId before iy can be instantiated."});if(this.def=r.retrieve(n)??null,!this.def)throw new l({source:this.constructor.name,message:`Unable to instantiate component "${n}" because it's not registered. Component should be registered using CompRegistry.register(ComponentClass) before instantiating a component.`});this.__instanceId=c(),this.__destroyed=!1,this.__context=e,this.renderedDom=null,this.renderingRoot=null,this.props=s,this.elementProps=new Map(s?Object.entries(s):[]),this.rendererEventListeners=new Map;const o=this.constructor.__compEventListeners;o&&o.forEach(((e,s)=>{e.forEach((e=>{const n=Object.getPrototypeOf(this)[e];"function"==typeof n?this.addRendererEventListener(s,n.bind(this)):t(`Unable to set event listener "${s}" because method "${e}" cannot be found on component "${this.constructor.name} at runtime!"`)}))})),this.rendererProps=Object.freeze(s)}get destroyed(){return this.__destroyed}get id(){return this.__instanceId}get rendered(){return null!==this.renderedDom}get root(){return this.throwIfDestroyed(),this.renderedDom&&this.renderingRoot?this.renderingRoot:null}get context(){if(!this.__context)throw new l({source:this.constructor.name,message:"Unable to get context because it's not set"});return this.__context}destroy(){this.destroyComponent()}destroyListItemComponent(){this.destroyComponent(!0)}render(e){if(!this.def)return;if(this.destroyed)return void t(`Unable to render component "${this.def?.id}" because it is already destroyed`);if(this.rendered||this.renderedDom)return void t(`Unable to render component "${this.def.id}" because it is already rendered`);const s=document.createDocumentFragment(),n=Object.getPrototypeOf(this).constructor.__compId,o=this.executeRenderer(s);if(!o)throw new h({source:this.constructor.name,message:`Unable to render component "${n}" because renderer returned null`});this.renderedDom=o;for(const[,e]of this.subComponents){const t=this.getSubComponentPortal(e.id);t&&this.mountSubComponentToPortal(e.id,t)}d((()=>{this.destroyed||(e.append(s),this.renderingRoot=e)}))}updateSubComponent(e,t,s){this.throwIfDestroyed();const n=this.subComponents.get(e);n&&!n.destroyed&&n.setProp(t,s)}addSubComponent(e,t,s){if(this.throwIfDestroyed(),this.subComponents.has(e))throw new l({source:this.constructor.name,message:`Unable to add sub-component "${e}" because it already exists`});if(this.subComponents.set(e,t),s&&this.subComponentElementIds.set(e,s),this.renderedDom){const t=this.getSubComponentPortal(e);t&&this.mountSubComponentToPortal(e,t)}}executeDomAction(e,...t){if(this.throwIfDestroyed(),!this.renderedDom)return void this.actionsOnDomReady.push((()=>this.executeDomAction(e,...t)));if(!this.renderingRoot)throw new h({source:this.constructor.name,message:"Unable to execute DOM action because renderingRoot is not set"});const s=this.renderedDom.actions[e];if(!s)throw new h({source:this.constructor.name,message:`Unable to execute DOM action "${String(e)}" because it does not exist`});return d((()=>s(...t)))}executeRenderer(e){const t=this.def?.render;if(!t)return null;if(this.renderingRoot)throw new h({source:this.constructor.name,message:"Unable to render component because renderingRoot is already set"});const s=t({appendToRoot:t=>{e.append(t),this.runDomActionsQueue()},compEvent:this.compEventGetter,props:this.rendererProps,context:this.context});return s&&(this.renderingRoot=e),s}getProp(e){return this.throwIfDestroyed(),this.elementProps.get(e)??null}getSubComponent(e){return this.subComponents.get(e)}hasSubComponent(e){return this.subComponents.has(e)}removeSubComponent(e){this.throwIfDestroyed();const t=this.subComponents.get(e);t&&(t.destroyed||t.destroy(),this.subComponents.delete(e),this.subComponentElementIds.delete(e))}runDomActionsQueue(){if(this.actionsOnDomReady.length>0&&this.rendered){const e=this.actionsOnDomReady;this.actionsOnDomReady=[];for(const t of e)d((()=>t()))}}setProp(e,s){this.destroyed?t(`Unable to set prop "${String(e)}" because component "${this.constructor.name}" is destroyed`):(null===s?this.elementProps.delete(e):this.elementProps.set(e,s),this.schedulePropUpdate(e),this.props=Object.freeze(Object.fromEntries(this.elementProps)))}throwIfDestroyed(){if(this.__destroyed)throw new l({source:this.constructor.name,message:"Unable to call method on destroyed component"})}addRendererEventListener(e,t){if(this.throwIfDestroyed(),this.rendererEventListeners.has(e))throw new l({source:this.constructor.name,message:`Unable to add event listener to rendererEvents "${e}" because it already exists`});this.rendererEventListeners.set(e,t)}destroyComponent(e=!1){if(this.throwIfDestroyed(),this.subComponents.forEach((e=>{e.destroy()})),this.renderedDom){this.renderedDom.elements&&(this.renderedDom.elements=void 0),this.renderedDom.actions&&(this.renderedDom.actions=void 0),this.renderedDom.onDestroy&&this.renderedDom.onDestroy();const t=this.renderingRoot;d((()=>{if(t)if(t instanceof DocumentFragment)for(;t.firstChild;)t.removeChild(t.firstChild);else e?t.parentElement?.removeChild(t):t.innerHTML=""})),this.renderedDom=null,this.renderingRoot=null}this.__destroyed=!0,this.__context=null,this.props=void 0,this.rendererEventListeners.clear(),this.subComponents.clear()}getSubComponentPortal(e){const t=this.subComponents.get(e),s=this.subComponentElementIds.get(e);if(!t||!s)return null;const n=(this.renderedDom?.elements)[s];return n instanceof HTMLElement?n:null}mountSubComponentToPortal(e,t){const s=this.subComponents.get(e);s?.render(t)}schedulePropUpdate(e){if(!this.renderedDom||!this.def?.update)return;const t=this.elementProps.get(e),s=this.renderedDom,n=this.renderingRoot,o=this.def.update;n&&d((()=>{o({propName:e,newValue:t,dom:{root:n,elements:s.elements,actions:s.actions},updateSubComponent:this.updateSubComponent})}))}}m.__compEventListeners=null,m.__compId=null,m.__renderer=null,m.__updater=null;const g=e=>{const t="function"==typeof e?e.__compId:void 0;if(!t)throw new Error("Invalid compClass! Component should be registered before using");const s=r.retrieve(t)?.model;if("function"!=typeof s)throw new Error(`Component "${t}" is not registered`);return{withContext:e=>({create:()=>new s(e,{}),withProps:t=>({create:()=>new s(e,t)})})}},C=(e,t,s)=>n=>{n.__compId=e,n.__renderer=t,n.__updater=s},f=e=>(t,s)=>{if("function"!=typeof t.constructor)throw new l({source:"CallbackFor",message:"@CallbackFor can only be used on methods of a class!"});t.constructor.hasOwnProperty("__compEventListeners")&&null!==t.constructor.__compEventListeners||(t.constructor.__compEventListeners=new Map);const n=t.constructor.__compEventListeners,o=n.get(e);o?o.push(s):n.set(e,[s])};var w=Object.defineProperty,y=Object.getOwnPropertyDescriptor;let x=class extends m{constructor(e,t){super(e,t),this.componentsById=new Map,this.componentsToRender=[],this.renderedComponents=[]}get size(){return this.renderedComponents.length}appendComponent(e,t){if(e.destroyed)throw new h({source:this.constructor.name,message:`Unable to append component "${e.id}" because it is already destroyed`});if(e.rendered)throw new h({source:this.constructor.name,message:`Unable to append component "${e.id}" because it is already rendered`});if(this.componentsById.has(e.id))throw new h({source:this.constructor.name,message:`Unable to append component "${e.id}" because it a component with the same id is already appended`});if(this.renderedComponents.includes(e))throw new h({source:this.constructor.name,message:`Unable to append component "${e.id}" because it is already appended`});if(!this.rendered)return this.componentsToRender.push({component:e,containerCssClass:t}),void this.componentsById.set(e.id,e);this.renderedComponents.push(e),d((()=>{if(!this.renderingRoot)return;const s=document.createElement("div");t&&(s.className=t),e.render(s),this.renderingRoot.append(s)}))}forEachComponent(e){this.renderedComponents.forEach(e)}getComponentAt(e){if(!(e<0||e>=this.renderedComponents.length))return this.renderedComponents[e]}getComponentById(e){for(const t of this.renderedComponents)if(t.id===e)return t}removeComponent(e){for(let t=0;t<this.renderedComponents.length;t++)if(this.renderedComponents[t]===e)return void this.removeComponentAt(t)}removeComponentAt(e){if(e<0||e>=this.renderedComponents.length)return;this.renderedComponents[e].destroyListItemComponent(),this.renderedComponents.splice(e,1)}removeComponentById(e){for(let t=0;t<this.renderedComponents.length;t++)if(this.renderedComponents[t].id===e)return void this.removeComponentAt(t)}render(e){if(this.throwIfDestroyed(),!this.def)return null;if(!this.renderedDom){const t=Object.getPrototypeOf(this).constructor.__compId,s=this.executeRenderer(e);if(!s)throw new h({source:this.constructor.name,message:`Unable to render list component "${t}" because renderer returned null`});this.renderedDom=s}if(this.componentsToRender.length>0){if(!(e instanceof HTMLElement))throw new h({source:this.constructor.name,message:"Unable to render list component because root is not an HTMLElement"});this.renderingRoot=e;for(const t of this.componentsToRender){const{component:s,containerCssClass:n}=t,o=document.createElement("div");n&&(o.className=n),s.render(o),e.append(o),this.renderedComponents.push(s)}this.componentsToRender=[]}}};x=((e,t,s,n)=>{for(var o,r=n>1?void 0:n?y(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&w(t,s,r),r})([C("list",(()=>({elements:{}})),(()=>{}))],x);const v=e=>/^[ \t]{2}\n$/m.test(e),b=e=>/^[ \t\n]{1}$/.test(e),k=["Root","Paragraph","LineBreak","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Blockquote","Heading1","Heading2","Heading3","Heading4","Heading5","Heading6","OrderedList","UnorderedList","Code","CodeBlock","HorizontalRule","Link","Image"],E=["^\\[$","^\\[[^\\]]+$","^\\[[^\\]]+\\]$","^\\[[^\\]]+\\]\\($","^\\[[^\\]]+\\]\\([^\\)]*$"],T={shouldOpen:/\[([^\]]+)\]\(([^\)]*)\)/,canOpen:e=>E.some((t=>new RegExp(t).test(e))),shouldClose:()=>!0,canClose:()=>!1},P=(e,t)=>s=>{const n=I.get(e);if(!n)throw new Error(`No sequence parsers found for markdown element ${e}`);const o=n[t];return o instanceof RegExp?o.test(s):o(s)},I=new Map;I.set("Code",{shouldOpen:/^`[^`]$/,canOpen:/^`$/,shouldClose:/^`[\s\S]+$/,canClose:/^`$/}),I.set("CodeBlock",{shouldOpen:/^```.*\n$/,canOpen:/^`{1,3}.*$/,shouldClose:/^\n?```[\s\S]+$/,canClose:/^\n$|^\n?`{1,3}$/}),I.set("Heading1",{shouldOpen:/^\n*#{1} $/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("Heading2",{shouldOpen:/^\n*#{2} +$/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("Heading3",{shouldOpen:/^\n*#{3} +$/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("Heading4",{shouldOpen:/^\n*#{4} +$/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("Heading5",{shouldOpen:/^\n*#{5} +$/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("Heading6",{shouldOpen:/^\n*#{6} +$/,canOpen:/^\n*#*$/,shouldClose:/^\n$/,canClose:()=>!1}),I.set("BoldAsterisk",{canOpen:/^\*{1,2}$/,shouldOpen:/^\*{2}[^(\s\n)]$/,canClose:/^\*{1,2}$/,shouldClose:/^\*{2}[\s\S]$/}),I.set("BoldUnderscore",{canOpen:/^_{1,2}$/,shouldOpen:/^_{2}[^(\s\n)]$/,canClose:/^_{1,2}$/,shouldClose:/^_{2}[\s\S]$/}),I.set("ItalicAsterisk",{canOpen:/^\*$/,shouldOpen:/^\*[^(\*\s\n)]$/,canClose:/^\*$/,shouldClose:/^\*[\s\S]$/}),I.set("ItalicUnderscore",{canOpen:/^_$/,shouldOpen:/^_[^(_\s\n)]$/,canClose:/^_$/,shouldClose:/^_[\s\S]$/}),I.set("Link",T),I.set("LineBreak",{shouldOpen:()=>!1,canOpen:()=>!1,shouldClose:()=>!1,canClose:()=>!1}),I.set("Root",{canOpen:()=>!1,shouldOpen:()=>!1,canClose:()=>!1,shouldClose:()=>!1}),I.set("Paragraph",{canOpen:/^\n+$/,shouldOpen:/^\n{2,}$/,canClose:/^\n$/,shouldClose:/^\n{2,}$/}),I.set("Blockquote",{shouldOpen:/^$/,canOpen:/^>$/,shouldClose:/^$/,canClose:/^$/}),I.set("OrderedList",{shouldOpen:/^$/,canOpen:/^\d+\. $/,shouldClose:/^\n$/,canClose:/^\n$/}),I.set("UnorderedList",{shouldOpen:/^$/,canOpen:/^\* $/,shouldClose:/^\n$/,canClose:/^\n$/}),I.set("HorizontalRule",{shouldOpen:/^$/,canOpen:/^---$/,shouldClose:/^$/,canClose:/^$/}),I.set("Image",{shouldOpen:/^$/,canOpen:/^!\[.*\]\(.*\)$/,shouldClose:/^$/,canClose:/^$/});class _{constructor(e,t="none",s="none"){this.__canLeadToClosingMarkdown=!1,this.__latestSequenceProcessed=!1,this.__markdownThatShouldBeNested=void 0,this.__markdownThatShouldBeRenderedAtParentLevel=void 0,this.__potentialNestedMarkdownElements=[],this.__potentialYieldingMarkdownElements=[],this.__sequence="",this.__shouldCloseCurrentMarkdown=!1,this.__markdownElement=e,this.__possibleNestedMarkdownElements="all"===t?k:"none"===t?[]:t,this.__possibleYieldingMarkdownElements="none"===s?[]:s}get canLeadToClosingOrNewMarkdown(){return this.__latestSequenceProcessed||this.processSequence(),this.__canLeadToClosingMarkdown||this.__potentialYieldingMarkdownElements.length>0||this.__potentialNestedMarkdownElements.length>0}get elementToCreateAtParentLevel(){return this.__latestSequenceProcessed||this.processSequence(),this.__markdownThatShouldBeRenderedAtParentLevel}get nestedElementToCreate(){return this.__latestSequenceProcessed||this.processSequence(),this.__markdownThatShouldBeNested}get sequence(){return this.__sequence}get shouldCloseCurrentMarkdown(){return this.__latestSequenceProcessed||this.processSequence(),this.__shouldCloseCurrentMarkdown}appendCharacter(e){this.__sequence+=e,this.__latestSequenceProcessed=!1}reset(){this.__sequence="",this.__latestSequenceProcessed=!1,this.__canLeadToClosingMarkdown=!1,this.__potentialYieldingMarkdownElements=[],this.__potentialNestedMarkdownElements=[],this.__shouldCloseCurrentMarkdown=!1,this.__markdownThatShouldBeRenderedAtParentLevel=void 0,this.__markdownThatShouldBeNested=void 0}processSequence(){if(this.__latestSequenceProcessed)return;const e=this.__sequence;this.__canLeadToClosingMarkdown=P(this.__markdownElement,"canClose")(e),this.__potentialYieldingMarkdownElements=this.__possibleYieldingMarkdownElements.filter((t=>P(t,"canOpen")(e))),this.__potentialNestedMarkdownElements=this.__possibleNestedMarkdownElements.filter((t=>P(t,"canOpen")(e))),this.__shouldCloseCurrentMarkdown=P(this.__markdownElement,"shouldClose")(e),this.__markdownThatShouldBeRenderedAtParentLevel=this.__possibleYieldingMarkdownElements.find((t=>P(t,"shouldOpen")(e))),this.__markdownThatShouldBeNested=this.__possibleNestedMarkdownElements.find((t=>P(t,"shouldOpen")(e)))}}class S{constructor(e,t,s,n,o){this.__initialized=!1,this.__last3Characters="",this.__options={},this.__yielded=!1,this.__markdownElementName=t,this.__parent=e??void 0,this.__options=o||{},this.__openingSequence=s??void 0,this.__initialContent="Root"!==t?n??void 0:void 0}get domElement(){return this.__element}get markdownElementName(){return this.__markdownElementName}get parsingChild(){return this.__parsingChild}get removeWhenEmpty(){return!1}get sequenceParser(){if(this.yielded)throw new Error("Cannot access sequence parser of a yielded processor");return this.__sequenceParser||(this.__sequenceParser=new _(this.__markdownElementName,this.nestedMarkdownElements,this.yieldingMarkdownElements)),this.__sequenceParser}get yielded(){return this.__yielded}get initialContent(){return this.__initialContent}get last3Characters(){return this.__last3Characters}get markdownProcessorOptions(){return this.__options}get syntaxHighlighter(){return this.__options.syntaxHighlighter}init(){if(!this.__initialized&&(this.__initialized=!0,"Root"!==this.__markdownElementName?this.__element=this.createElement(this.__openingSequence):this.__element=void 0,this.__initialContent))for(let e=0;e<this.__initialContent.length;e++){const t=this.__initialContent[e];this.processCharacter(t)}}parsingChildYielded(e,t,s,n){this.__parsingChild===e&&(this.__parsingChild=void 0),t&&this.createAndAppendMarkdown(t,s),n&&this.processCharacter(n)}preProcessCharacter(e){this.__last3Characters.length<3?this.__last3Characters+=e:this.__last3Characters=this.__last3Characters.slice(1)+e}purgeSequence(){this.__parsingChild&&this.__parsingChild.purgeSequence(),this.__sequenceParser?.sequence&&(this.__element?.append(this.__sequenceParser.sequence),this.__sequenceParser.reset())}resetSequenceParser(){this.__sequenceParser?.reset(),this.__sequenceParser=new _(this.__markdownElementName,this.nestedMarkdownElements,this.yieldingMarkdownElements)}setParsingChild(e){if(this.__parsingChild&&"Root"!==this.__markdownElementName)throw new Error("Cannot set spawn child while parsing child");this.__parsingChild=e,e.domElement&&this.domElement?.append(e.domElement),e.__parent=this}yield(e,t){if(this.yielded)return;const s=this.__sequenceParser&&!this.__sequenceParser?.shouldCloseCurrentMarkdown?this.__sequenceParser?.sequence:void 0;this.__yielded=!0,this.__sequenceParser=void 0,this.__parsingChild&&(this.__parsingChild.yield(),this.__parsingChild=void 0),this.__element&&(this.__element.innerHTML=this.__element.innerHTML.trim(),this.removeWhenEmpty&&""===this.__element.innerHTML&&this.__element.remove(),this.__element=void 0),this.__parent&&(this.__parent.parsingChildYielded(this,e,s,t),this.__parent=void 0)}}class L extends S{constructor(e,t,s,n,o){super(e,t,s,n,o)}createAndAppendMarkdown(e,t){W(e,this,t,void 0,this.markdownProcessorOptions),this.sequenceParser.reset()}processCharacter(e){if(this.preProcessCharacter(e),this.parsingChild)return void this.parsingChild.processCharacter(e);const{sequenceDiscarded:t,discardedSequence:s,yielded:n}=this.processSequence(e);if(!n)if(v(this.last3Characters)&&(this.nestedMarkdownElements.includes("LineBreak")||"all"===this.nestedMarkdownElements))this.domElement?.innerHTML&&(this.domElement.innerHTML=this.domElement?.innerHTML.trim()),this.createAndAppendMarkdown("LineBreak"),this.sequenceParser.reset();else if(t){this.resetSequenceParser();this.processSequence(e).sequenceDiscarded?(this.sequenceParser.reset(),s&&this.domElement?.append(s)):s&&s.length>1&&this.domElement?.append(s.slice(0,-1))}}processSequence(e){if(this.sequenceParser.appendCharacter(e),this.sequenceParser.shouldCloseCurrentMarkdown)return this.yield(void 0,e),{sequenceDiscarded:!1,yielded:!0};if(this.sequenceParser.elementToCreateAtParentLevel)return this.yield(this.sequenceParser.elementToCreateAtParentLevel,e),{sequenceDiscarded:!1,yielded:!0};const t=this.sequenceParser.nestedElementToCreate;if(t)return W(t,this,this.sequenceParser.sequence,e,this.markdownProcessorOptions),this.sequenceParser.reset(),{sequenceDiscarded:!1};if(this.sequenceParser.canLeadToClosingOrNewMarkdown)return{sequenceDiscarded:!1};const s=this.sequenceParser.sequence;return this.sequenceParser.reset(),{sequenceDiscarded:!0,discardedSequence:s}}}class M extends L{constructor(e,t,s){super(e,"BoldAsterisk",t??null,s??null,null)}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["LineBreak","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("strong")}}class O extends L{constructor(e,t,s){super(e,"BoldUnderscore",t??null,s??null,null)}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["LineBreak","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("strong")}}class A extends L{constructor(e,t,s){super(e,"Code",t??null,s??null,null)}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("code")}}class $ extends L{constructor(e,t,s,n={}){super(e,"CodeBlock",t??null,!s||b(s)?null:s,n),this.codeContainer=null,this.currentLineContainer=null,this.language=this.extractLanguageFromOpeningSequence(t)}get canExistAtRootLevel(){return!0}get nestedMarkdownElements(){return"none"}get yieldingMarkdownElements(){return"none"}createElement(){const e=document.createElement("div");return e.classList.add("code-block"),this.codeContainer=document.createElement("pre"),e.append(this.codeContainer),this.language&&(this.codeContainer.dataset.language=this.language),e}processCharacter(e){this.preProcessCharacter(e);const{sequenceDiscarded:t,discardedSequence:s,yielded:n}=this.processSequence(e);if(n)return;if(!t)return;if(s&&s.length>1&&this.codeContainer)for(let e=0;e<s.length-1;e++)this.appendCharacterToCodeBlock(s[e]);this.resetSequenceParser();this.processSequence(e).sequenceDiscarded&&(this.sequenceParser.reset(),this.appendCharacterToCodeBlock(e))}yield(e,t){this.highlightCurrentLine(),this.markdownProcessorOptions.skipCopyToClipboardButton||this.insertCopyToClipboardButton(),super.yield(e,t),this.codeContainer=null,this.currentLineContainer=null}appendCharacterToCodeBlock(e){if(this.codeContainer)if("\n"!==e)this.currentLineContainer||(this.currentLineContainer=document.createElement("div"),this.codeContainer.append(this.currentLineContainer)),this.currentLineContainer.append(e);else if(this.currentLineContainer)this.currentLineContainer.innerHTML?this.highlightCurrentLine():this.currentLineContainer.innerHTML=" ",this.currentLineContainer=null;else if(this.codeContainer.innerHTML){const e=document.createElement("div");e.innerHTML=" ",this.codeContainer.append(e)}}extractLanguageFromOpeningSequence(e){if(!e)return;const t=e.match(/```(\w+)/);return Array.isArray(t)&&t.length>1?t[1]:void 0}highlightCurrentLine(){if(!this.domElement||!this.currentLineContainer)return;const e=this.currentLineContainer.innerText??this.currentLineContainer.innerHTML;if(this.syntaxHighlighter&&this.codeContainer&&e){const t=this.codeContainer.dataset.language;if(t){const s=this.syntaxHighlighter.createHighlighter({language:t,colorMode:"dark"}),n=this.syntaxHighlighter.highlightingClass(t);this.codeContainer.classList.contains(n)||this.codeContainer.classList.add(n),this.currentLineContainer.innerHTML=s(e,t)}}}insertCopyToClipboardButton(){if(!this.domElement)return;const e="Copy code to clipboard",t=document.createElement("button");t.classList.add("copy-button"),t.setAttribute("aria-label",e),t.setAttribute("title",e),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M15 1.25H10.9436C9.10583 1.24998 7.65019 1.24997 6.51098 1.40314C5.33856 1.56076 4.38961 1.89288 3.64124 2.64124C2.89288 3.38961 2.56076 4.33856 2.40314 5.51098C2.24997 6.65019 2.24998 8.10582 2.25 9.94357V16C2.25 17.8722 3.62205 19.424 5.41551 19.7047C5.55348 20.4687 5.81753 21.1208 6.34835 21.6517C6.95027 22.2536 7.70814 22.5125 8.60825 22.6335C9.47522 22.75 10.5775 22.75 11.9451 22.75H15.0549C16.4225 22.75 17.5248 22.75 18.3918 22.6335C19.2919 22.5125 20.0497 22.2536 20.6517 21.6517C21.2536 21.0497 21.5125 20.2919 21.6335 19.3918C21.75 18.5248 21.75 17.4225 21.75 16.0549V10.9451C21.75 9.57754 21.75 8.47522 21.6335 7.60825C21.5125 6.70814 21.2536 5.95027 20.6517 5.34835C20.1208 4.81753 19.4687 4.55348 18.7047 4.41551C18.424 2.62205 16.8722 1.25 15 1.25ZM17.1293 4.27117C16.8265 3.38623 15.9876 2.75 15 2.75H11C9.09318 2.75 7.73851 2.75159 6.71085 2.88976C5.70476 3.02502 5.12511 3.27869 4.7019 3.7019C4.27869 4.12511 4.02502 4.70476 3.88976 5.71085C3.75159 6.73851 3.75 8.09318 3.75 10V16C3.75 16.9876 4.38624 17.8265 5.27117 18.1293C5.24998 17.5194 5.24999 16.8297 5.25 16.0549V10.9451C5.24998 9.57754 5.24996 8.47522 5.36652 7.60825C5.48754 6.70814 5.74643 5.95027 6.34835 5.34835C6.95027 4.74643 7.70814 4.48754 8.60825 4.36652C9.47522 4.24996 10.5775 4.24998 11.9451 4.25H15.0549C15.8297 4.24999 16.5194 4.24998 17.1293 4.27117ZM7.40901 6.40901C7.68577 6.13225 8.07435 5.9518 8.80812 5.85315C9.56347 5.75159 10.5646 5.75 12 5.75H15C16.4354 5.75 17.4365 5.75159 18.1919 5.85315C18.9257 5.9518 19.3142 6.13225 19.591 6.40901C19.8678 6.68577 20.0482 7.07435 20.1469 7.80812C20.2484 8.56347 20.25 9.56458 20.25 11V16C20.25 17.4354 20.2484 18.4365 20.1469 19.1919C20.0482 19.9257 19.8678 20.3142 19.591 20.591C19.3142 20.8678 18.9257 21.0482 18.1919 21.1469C17.4365 21.2484 16.4354 21.25 15 21.25H12C10.5646 21.25 9.56347 21.2484 8.80812 21.1469C8.07435 21.0482 7.68577 20.8678 7.40901 20.591C7.13225 20.3142 6.9518 19.9257 6.85315 19.1919C6.75159 18.4365 6.75 17.4354 6.75 16V11C6.75 9.56458 6.75159 8.56347 6.85315 7.80812C6.9518 7.07435 7.13225 6.68577 7.40901 6.40901Z" fill="currentColor"/></svg>';const s=this.codeContainer;let n=!1;t.addEventListener("click",(()=>{if(n||!s)return;const e=s.innerText;navigator.clipboard.writeText(e??""),n=!0,t.classList.add("clicked"),setTimeout((()=>{n=!1,t.classList.remove("clicked")}),1e3)})),this.domElement.insertAdjacentElement("beforebegin",t)}}class B extends L{constructor(e,t,s,n){super(t,D(e),s??null,n??null,null),this.__headingLevel=e}get canExistAtRootLevel(){return!0}get nestedMarkdownElements(){return["BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("h"+this.__headingLevel)}processCharacter(e){if(this.preProcessCharacter(e),this.parsingChild)return void this.parsingChild.processCharacter(e);const{sequenceDiscarded:t,discardedSequence:s,yielded:n}=this.processSequence(e);n||t&&s&&(/^\s+$/.test(s)||this.domElement?.append(s))}}const D=e=>{switch(e){case 1:return"Heading1";case 2:return"Heading2";case 3:return"Heading3";case 4:return"Heading4";case 5:return"Heading5";case 6:return"Heading6"}};class R extends L{constructor(e,t,s){super(e,"ItalicAsterisk",t??null,s??null,null)}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["LineBreak","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("em")}}class H extends L{constructor(e,t,s){super(e,"ItalicUnderscore",t??null,s??null,null)}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["LineBreak","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get yieldingMarkdownElements(){return"none"}createElement(){return document.createElement("em")}}class q extends S{constructor(e,t,s){super(e,"LineBreak",t??null,s??null,null)}get canExistAtRootLevel(){return!0}get nestedMarkdownElements(){return"none"}get yieldingMarkdownElements(){return"none"}createAndAppendMarkdown(e,t){W(e,this,t,void 0,this.markdownProcessorOptions),this.sequenceParser.reset()}createElement(){return document.createElement("br")}init(){super.init()}processCharacter(e){this.yield(void 0,e)}}class U extends L{constructor(e,t,s,n={}){super(e,"Link",t??null,s??null,n),this.linkContentProcessed=""}get canExistAtRootLevel(){return!1}get nestedMarkdownElements(){return["BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code"]}get yieldingMarkdownElements(){return["Paragraph","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code"]}createElement(e){const t=/\[(.*[^\]])\]\((.*[^\)])\)/.exec(e),s=document.createElement("a");return s.textContent="",t&&t.length>=3&&t[2]&&(s.href=t[2]),this.markdownProcessorOptions.openLinksInNewWindow&&(s.target="_blank"),s}processCharacter(e){super.processCharacter(e),this.yielded||(this.linkContentProcessed+=e)}processSequence(e){if(!this.initialContent||this.initialContent===this.linkContentProcessed)return this.yield(void 0,e),{yielded:!0,sequenceDiscarded:!0,discardedSequence:e};this.sequenceParser.appendCharacter(e);const t=this.sequenceParser.nestedElementToCreate;if(t)return W(t,this,this.sequenceParser.sequence,e,this.markdownProcessorOptions),this.sequenceParser.reset(),{sequenceDiscarded:!1};if(this.sequenceParser.canLeadToClosingOrNewMarkdown)return{sequenceDiscarded:!1};const s=this.sequenceParser.sequence;return this.sequenceParser.reset(),{sequenceDiscarded:!0,discardedSequence:s}}}class N extends L{constructor(e,t,s){super(e,"Paragraph",t??null,s??null,null)}get canExistAtRootLevel(){return!0}get nestedMarkdownElements(){return["LineBreak","Blockquote","BoldAsterisk","ItalicAsterisk","BoldUnderscore","ItalicUnderscore","Code","Link"]}get removeWhenEmpty(){return!0}get yieldingMarkdownElements(){return["Heading1","Heading2","Heading3","Heading4","Heading5","Heading6","CodeBlock","UnorderedList","OrderedList","HorizontalRule","Image"]}createElement(){return document.createElement("p")}}const W=(e,t,s,n,o)=>{if("Paragraph"===e){const e=new N(t,s,n);return e.init(),void t.setParsingChild(e)}if("LineBreak"===e){const e=new q(t,s,n);return e.init(),void t.setParsingChild(e)}if("Link"===e){const e=/\[([^\]]+)\]\(([^\)]*)\)/.exec(s),n=e&&e.length>=3?e[1]:"",r=new U(t,s,n,o);return r.init(),void t.setParsingChild(r)}if("Heading1"===e||"Heading2"===e||"Heading3"===e||"Heading4"===e||"Heading5"===e||"Heading6"===e){const o=parseInt(e[e.length-1]);if(Number.isNaN(o)||!Number.isFinite(o)||o<1||o>6)throw new Error("Invalid heading level");const r=new B(o,t,s,n);return r.init(),void t.setParsingChild(r)}if("Code"===e){const e=new A(t,s,n);return e.init(),void t.setParsingChild(e)}if("CodeBlock"===e){const e=new $(t,s,n,o);return e.init(),void t.setParsingChild(e)}if("BoldAsterisk"===e){const e=new M(t,s,n);return e.init(),void t.setParsingChild(e)}if("BoldUnderscore"===e){const e=new O(t,s,n);return e.init(),void t.setParsingChild(e)}if("ItalicAsterisk"===e){const e=new R(t,s,n);return e.init(),void t.setParsingChild(e)}if("ItalicUnderscore"===e){const e=new H(t,s,n);return e.init(),void t.setParsingChild(e)}throw new Error("Unable to create child processor for markdown element "+e)};class z extends S{constructor(e,t,s){super(null,"Root",t??null,null,s??null),this.__rootDomElement=e}get canExistAtRootLevel(){return!1}get domElement(){return this.__rootDomElement}get nestedMarkdownElements(){return"all"}get yieldingMarkdownElements(){return"none"}complete(){var e;this.parsingChild&&this.parsingChild.purgeSequence(),this.purgeSequence(),e=this.domElement?.lastChild,e instanceof HTMLElement&&"BR"===e.tagName&&this.domElement?.lastChild?.remove()}createAndAppendMarkdown(e,t){W(e,this,t,void 0,this.markdownProcessorOptions),this.sequenceParser.reset()}createElement(){throw new Error("Root cannot create an element")}processCharacter(e){this.preProcessCharacter(e),this.parsingChild?this.parsingChild.processCharacter(e):(this.sequenceParser.appendCharacter(e),this.processSequence(e))}yield(){super.yield(),this.__rootDomElement=void 0}processSequence(e){if(this.sequenceParser.shouldCloseCurrentMarkdown)return;const t=this.sequenceParser.nestedElementToCreate;if(t){W(t,this,this.sequenceParser.sequence,e,this.markdownProcessorOptions);const s=this.parsingChild;return s&&!s.canExistAtRootLevel&&(W("Paragraph",this),this.parsingChild?.setParsingChild(s)),void this.sequenceParser.reset()}this.sequenceParser.canLeadToClosingOrNewMarkdown||(v(this.last3Characters)?this.createAndAppendMarkdown("LineBreak"):e&&!b(e)&&(W("Paragraph",this,void 0,this.sequenceParser.sequence),this.sequenceParser.reset()))}}const j=10,Q=(e,t,s)=>{const{streamingAnimationSpeed:n=j,skipAnimation:o=!1,skipCopyToClipboardButton:r=!1,openLinksInNewWindow:i=!1}=s||{},a=new z(e,void 0,{syntaxHighlighter:t,skipCopyToClipboardButton:r,openLinksInNewWindow:i}),d=[],c=new Set;let h=0,l=!1,u=!1;const p=o?0:Math.max(n,0),m=Math.ceil(200/j),g=()=>{if(0===d.length&&h<m)return h+=1,void setTimeout(g,p);if(0===d.length&&h===m)return l=!1,void(u&&(a.processCharacter("\n"),a.complete(),a.yield(),c.forEach((e=>e())),c.clear()));if(d.length>0){const e=d.shift();e&&a.processCharacter(e),l=!0,h=0}setTimeout(g,p)};return{next:e=>{if(e){for(let t=0;t<e.length;t++)d.push(e[t]);l||g()}},complete:()=>{u=!0},onComplete:e=>{u||c.add(e)}}},F=(e,t)=>{let s=!1;const n=t?e.querySelector(t):e,o=n instanceof HTMLElement?n:void 0;if(!o)throw new p({source:"dom/listenTo",message:`Could not find element with query "${t}". Make sure the query provided matches an element that exists in the root element.`});const r=new Map,i=new Map,a=()=>{o&&(r.forEach(((e,t)=>{o.removeEventListener(t,e)})),r.clear(),i.clear())},d={on:(e,t)=>{if(!t||!o)return d;if(!r.has(e)){const t=t=>{i.get(e)?.forEach((e=>e(t)))};r.set(e,t),o.addEventListener(e,t)}i.has(e)||i.set(e,new Set);return i.get(e).add(t),d},get:()=>{if(s)throw new Error("listenTo().get() can only be used once!");return s=!0,[o,a]}};return d},V=e=>new Array(e.length+1).join("&nbsp;"),G=e=>{const s=document.createElement("div");s.innerHTML=e.trim();const n=document.createDocumentFragment();for(;s.firstChild;)n.append(s.firstChild);if(n.firstChild){for(let e=0;e<n.children.length;e++){if(!(n.children[e]instanceof HTMLElement))return void t("render() function rendered a non HTMLElement")}return 1===n.children.length?n.children[0]:n}},Y=(e,t)=>`#${e}/${t}`,K=e=>{const s=G(`<div class="${X("persona")}"></div>`);if(!(s&&s instanceof HTMLElement))return;if(!e.picture||!(e.picture instanceof HTMLElement)&&"string"!=typeof e.picture)return void t("Persona picture is not a string or a valid HTMLElement");const n=e.name?e.name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"";const o=document.createElement("div");if(o.classList.add(X("persona-photo-container")),o.ariaRoleDescription="Persona Photo"+(n?` For Chat Participant ${n}`:""),e.picture instanceof HTMLElement){const s=e.picture.cloneNode(!0);if(!(s instanceof HTMLElement))return void t("Photo dom element is not an HTMLElement");o.append(s)}else{const t=document.createElement("span");t.classList.add(X("persona-letter"));const s=e.name&&e.name.length>0?e.name[0].toUpperCase():"";s.length>0&&t.append(s),o.append(t);const n=document.createElement("div");n.classList.add(X("persona-rendered-photo")),n.style.backgroundImage=`url("${encodeURI(e.picture)}")`,o.append(n)}return s.append(o),s},X=e=>`nluxc-text-message-${e}`,Z=({content:e})=>`<div class="${X("content")}" tabindex="0">${e?(e=>{let t=e.replace(/<\/?[^>]+(>|$)/g,"");return t=t.replace(/\n/g,"<br />"),t=t.replace(/\s\s+/g,V),t})(e):""}</div>`;var J=Object.defineProperty,ee=Object.getOwnPropertyDescriptor,te=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?ee(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&J(t,s,r),r};let se=class extends m{constructor(e,t){super(e,t),this.contentStatusChangeListeners=new Set,this.domChangeListeners=new Set,this.resizeListeners=new Set,this.__content=t.content,this.contentType=t.contentType,this.contentStatus=t.loadingStatus}get content(){return this.__content}get direction(){return this.props?.direction}appendContent(e){if("stream"!==this.contentType)throw new Error("CompMessage: content can only be appended when contentType is 'stream'!");if("streaming"!==this.contentStatus&&"connecting"!==this.contentStatus)throw new Error("CompMessage: Content can only be appended when contentStatus is 'streaming' or 'connecting'!");"connecting"===this.contentStatus&&this.setContentLoadingStatus("streaming"),this.__content=this.content?this.content+e:e,this.executeDomAction("appendContent",e)}commitContent(){if("stream"!==this.contentType)throw new Error("CompMessage: content can only be committed when contentType is 'stream'!");if("streaming"!==this.contentStatus&&"connecting"!==this.contentStatus)throw new Error("CompMessage: content can only be committed when contentStatus is 'streaming' or 'connecting'!");this.executeDomAction("commitContent"),this.setContentLoadingStatus("loaded")}destroy(){this.resizeListeners.clear(),this.contentStatusChangeListeners.clear(),super.destroy()}onContentStatusChange(e){this.contentStatusChangeListeners.add(e)}onDomChange(e){this.domChangeListeners.add(e)}onResize(e){this.resizeListeners.add(e)}removeContentStatusChangeListener(e){this.contentStatusChangeListeners.delete(e)}removeDomChangeListener(e){this.domChangeListeners.delete(e)}removeResizeListener(e){this.resizeListeners.delete(e)}setContent(e){if("promise"!==this.contentType)throw new Error("CompMessage: content can only be set when contentType is 'promise'!");if("loading"!==this.contentStatus)throw new Error("CompMessage: content can only be set when contentStatus is 'loading'!");this.__content=e,this.setContentLoadingStatus("loaded"),this.executeDomAction("appendContent",e)}setErrored(){if("loaded"===this.contentStatus||"loading-error"===this.contentStatus)throw new Error("CompMessage: Content cannot be erred when it is already loaded or errored!");this.setContentLoadingStatus("loading-error")}setPersona(e){if(!this.props)throw new Error("CompMessage: Cannot set bot persona before props are initialized!");this.executeDomAction("updatePersona",e)}setStreamingAnimationSpeed(e){this.setProp("streamingAnimationSpeed",e)}handleCompCopyToClipboardTriggered(e){e.preventDefault(),this.__content&&navigator.clipboard.writeText(this.__content).catch((e=>{t("Failed to copy selected message to clipboard!")}))}handleDomChange(){this.domChangeListeners.forEach((e=>e()))}handleResize(){this.resizeListeners.forEach((e=>e()))}setContentLoadingStatus(e){if(this.contentStatus!==e){if("static"===this.contentType&&"loaded"!==e)throw new Error("CompMessage: contentStatus can only be 'loaded' when contentType is 'static'!");if("stream"===this.contentType&&"loading"===e)throw new Error("CompMessage: contentStatus cannot be 'loading' when contentType is 'stream'!");this.contentStatus=e,this.setProp("loadingStatus",e),this.contentStatusChangeListeners.forEach((e=>e(this.contentStatus))),"loaded"!==e&&"loading-error"!==e||this.contentStatusChangeListeners.clear()}}};te([f("copy-to-clipboard-triggered")],se.prototype,"handleCompCopyToClipboardTriggered",1),te([f("message-container-dom-changed")],se.prototype,"handleDomChange",1),te([f("message-container-resized")],se.prototype,"handleResize",1),se=te([C("message",(({appendToRoot:e,props:t,context:s,compEvent:n})=>{if("text"!==t.format)throw new p({source:Y("message","render"),message:`Unsupported format: ${t.format}! Only text is currently supported!`});const o=G(Z(t));if(!o)throw new p({source:Y("prompt-box","render"),message:"Message could not be rendered"});let r;"in"===t.direction&&t.botPersona?r=K(t.botPersona):"out"===t.direction&&t.userPersona&&(r=K(t.userPersona));const i=document.createElement("div");r&&i.prepend(r);const a="in"===t.direction?"received":"sent";let d=`message-status-${t.loadingStatus}`;i.append(o);const c=G(`<div class="${X("loader")}"><div class="spinning-loader-container"><span class="spinning-loader"></span></div></div>`),h=c instanceof HTMLElement?c:void 0;!h||"loading"!==t.loadingStatus&&"connecting"!==t.loadingStatus||i.append(h),i.classList.add(X("container")),i.classList.add(X(a)),i.classList.add(d);const[l,u]=F(i,`:scope > .${X("content")}`).on("keydown",(e=>{if((e.ctrlKey||e.metaKey)&&"c"===e.key){const t=n("copy-to-clipboard-triggered");"function"==typeof t&&t(e)}else;})).on("click",(e=>{!e||!e.target||e.target instanceof HTMLAnchorElement||(e.stopPropagation(),e.preventDefault())})).get();e(i);const{trackResize:m,trackDomChange:g}=t;let C,f,w;m&&(f=new ResizeObserver((()=>{n("message-container-resized")()})),f.observe(l)),g&&(w=new MutationObserver((()=>{n("message-container-dom-changed")()})),w.observe(l,{childList:!0,subtree:!0,characterData:!0}));const y=()=>{f?.disconnect(),w?.disconnect(),f=void 0,w=void 0,C=void 0};return{elements:{container:i,contentContainer:l,loader:h},actions:{focus:()=>{l.focus()},appendContent:e=>{C||(C=Q(l,s.syntaxHighlighter,{streamingAnimationSpeed:t.streamingAnimationSpeed,skipAnimation:!1,skipCopyToClipboardButton:!1}),C.onComplete(y)),C.next(e)},commitContent:()=>{C?.complete&&C.complete()},setContentStatus:e=>{i.classList.remove(d),d=`message-status-${e}`,i.classList.add(d),h&&("loading"===e||"connecting"===e?!h.parentNode&&i.append(h):h.parentNode&&h.remove())},updatePersona:e=>{r?.remove(),r=void 0,e&&(r=K(e),r&&i.prepend(r))}},onDestroy:()=>{u(),f?.disconnect(),w?.disconnect(),f=void 0,w=void 0}}}),(({propName:e,newValue:t,dom:s})=>{"loadingStatus"===e&&t&&s.actions?.setContentStatus(t)}))],se);const ne=()=>`<div class="${ie("welcome-message")}"></div>`,oe=()=>{const e=G(ne());if(e&&e instanceof HTMLElement)return e},re=e=>{const s=G(ne());if(!(s&&s instanceof HTMLElement))return;if(!e.picture||!(e.picture instanceof HTMLElement)&&"string"!=typeof e.picture)return void t("Welcome persona picture is not a string or a valid HTMLElement");const n=document.createElement("div");if(n.classList.add(ie("welcome-message-photo-container")),n.ariaRoleDescription="Persona Photo"+(e.name?` For Chat Participant ${e.name}`:""),e.picture instanceof HTMLElement){const s=e.picture.cloneNode(!0);if(!(s instanceof HTMLElement))return void t("Photo dom element is not an HTMLElement");n.append(s)}else{const t=document.createElement("span");t.classList.add(ie("welcome-message-letter")),t.innerText=e.name&&e.name.length>0?e.name[0].toUpperCase():"",n.append(t);const s=document.createElement("div");s.classList.add(ie("welcome-message-rendered-photo")),s.style.backgroundImage=`url("${encodeURI(e.picture)}")`,n.append(s)}if(s.append(n),e.tagline){const t=document.createElement("div");t.classList.add(ie("welcome-message-name-and-tagline"));const n=document.createElement("h3");n.classList.add(ie("welcome-message-name")),n.append(e.name);const o=document.createElement("span");o.classList.add(ie("welcome-message-tagline")),o.append(e.tagline),t.append(n),t.append(o),s.append(t)}return s},ie=e=>`nluxc-conversation-${e}`;var ae=Object.defineProperty,de=Object.getOwnPropertyDescriptor,ce=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?de(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&ae(t,s,r),r};let he=class extends m{constructor(e,t){super(e,t),this.conversationContent=[],this.messagesContainerRendered=!1,this.scrollingStickToConversationEnd=!0,this.addConversation(),this.scrollWhenGeneratingUserOption=t.scrollWhenGenerating??!0,this.conversationContent=t.messages?.map((e=>({...e})))??[]}addMessage(e,t,s,n){if(!this.messagesList||!this.props)throw new Error("CompConversation: messagesList is not initialized! Make sure you calladdConversation() before calling addMessage()!");this.messagesContainerRendered||(this.executeDomAction("removeWelcomeMessage"),this.messagesContainerRendered=!0);const o=this.props.scrollWhenGenerating,{botPersona:r,userPersona:i,streamingAnimationSpeed:a}=this.props,d=((e,t,s,n,o,r,i,a,d)=>{const c={format:"text",loadingStatus:"stream"===o?"connecting":"promise"===o?"loading":"loaded",streamingAnimationSpeed:n,contentType:o,content:r,createdAt:i??new Date,trackResize:s,trackDomChange:s},h="in"===t?{...c,direction:t,botPersona:a}:{...c,direction:t,userPersona:d};return g(se).withContext(e).withProps(h).create()})(this.context,e,o,a,t,n,s,r,i);if(this.lastMessageId&&this.lastMessageResizedListener){const e=this.getMessageById(this.lastMessageId);e&&(e.removeResizeListener(this.lastMessageResizedListener),e.removeDomChangeListener(this.lastMessageResizedListener)),this.lastMessageId=void 0,this.lastMessageResizedListener=void 0}return this.messagesList.appendComponent(d,"message-container-in-list"),this.executeDomAction("scrollToBottom"),this.lastMessageId=d.id,this.lastMessageResizedListener=this.createMessageResizedListener(d.id),this.lastMessageResizedListener&&(d.onResize(this.lastMessageResizedListener),d.onDomChange(this.lastMessageResizedListener)),d.id}getConversationContentForAdapter(e="max"){if("number"==typeof e&&e<=0)n(`Invalid value provided for 'historyPayloadSize' : "${e}"! Value must be a positive integer or 'all'.`);else if("none"!==e)return"max"===e?[...this.conversationContent]:this.conversationContent.slice(-e)}getMessageById(e){return this.messagesList?.getComponentById(e)}removeMessage(e){this.messagesList?.removeComponentById(e),this.messagesList&&0!==this.messagesList.size||(this.executeDomAction("resetWelcomeMessage"),this.messagesContainerRendered=!1)}setBotPersona(e){this.setProp("botPersona",e),this.messagesList?.forEachComponent((t=>{"in"===t.direction&&t.setPersona(e)}))}setStreamingAnimationSpeed(e){this.setProp("streamingAnimationSpeed",e),this.messagesList?.forEachComponent((t=>{t.setStreamingAnimationSpeed(e)}))}setUserPersona(e){this.setProp("userPersona",e),this.messagesList?.forEachComponent((t=>{"out"===t.direction&&t.setPersona(e)}))}toggleAutoScrollToStreamingMessage(e){this.scrollWhenGeneratingUserOption=e}updateConversationContent(e){this.conversationContent.push(e)}addConversation(){this.messagesList=g(x).withContext(this.context).create(),this.addSubComponent(this.messagesList.id,this.messagesList,"messagesContainer");const e=this.props?.messages;e&&e.filter((e=>"system"!==e.role)).forEach((e=>{this.addMessage("ai"===e.role?"in":"out","static",new Date,e.message)}))}createMessageResizedListener(e){if(this.getMessageById(e))return()=>{!this.destroyed&&this.scrollWhenGeneratingUserOption&&this.scrollingStickToConversationEnd&&this.executeDomAction("scrollToBottom")}}handleUserScrolled({scrolledToBottom:e,scrollDirection:t}){this.scrollingStickToConversationEnd?"up"===t&&(this.scrollingStickToConversationEnd=!1):"down"===t&&e&&(this.scrollingStickToConversationEnd=!0)}};ce([f("user-scrolled")],he.prototype,"handleUserScrolled",1),he=ce([C("conversation",(({appendToRoot:e,compEvent:t,props:s})=>{const n={botPersona:s.botPersona,welcomeMessageContainer:void 0,shouldRenderWelcomeMessage:!s.messages||0===s.messages.length},o=G(`<div class="${ie("messages-container")}"></div>`);if(!(o instanceof HTMLElement))throw new p({source:Y("chat-room","render"),message:"Conversation component could not be rendered"});const r=new Set,i=(e=>{let t,s;return n=>{const o=n.target;if(!(o instanceof HTMLElement))return;const{scrollTop:r,clientHeight:i,scrollHeight:a}=o,d=a-30,c=Math.ceil(r+i)>=d,h=void 0===t||void 0===s?void 0:r>t&&s===a?"down":r<t&&s===a?"up":void 0;s=a,t=r,e({scrolledToBottom:c,scrollDirection:h})}})((e=>{t("user-scrolled")(e)})),[,a]=F(o).on("scroll",((e,t)=>{let s=!1;if("function"!=typeof e)throw new h({source:"x/throttle",message:"Callback must be a function"});return(...n)=>{s||(e.apply(void 0,n),s=!0,setTimeout((function(){s=!1}),t))}})(i,50)).get();if(e(o),n.shouldRenderWelcomeMessage)if(s.botPersona){const e=s.botPersona;n.welcomeMessageContainer=re(e),n.welcomeMessageContainer&&o.append(n.welcomeMessageContainer)}else n.welcomeMessageContainer=oe();return{elements:{messagesContainer:o},actions:{scrollToBottom:()=>{o.scrollTo({top:5e4,behavior:"instant"})},removeWelcomeMessage:()=>{n.welcomeMessageContainer&&(n.welcomeMessageContainer.remove(),n.welcomeMessageContainer=void 0)},resetWelcomeMessage:()=>{n.welcomeMessageContainer&&(n.welcomeMessageContainer.remove(),n.welcomeMessageContainer=void 0),n.welcomeMessageContainer=n.botPersona?re(n.botPersona):oe(),n.welcomeMessageContainer&&o.append(n.welcomeMessageContainer)},updateBotPersona:e=>{n.botPersona=e,n.welcomeMessageContainer&&(n.welcomeMessageContainer.remove(),n.welcomeMessageContainer=void 0,n.welcomeMessageContainer=n.botPersona?re(n.botPersona):oe(),n.welcomeMessageContainer&&o.append(n.welcomeMessageContainer))},updateUserPersona:e=>{}},onDestroy:()=>{r.clear(),a()}}}),(({propName:e,newValue:t,dom:{elements:s,actions:n}})=>{if("botPersona"!==e);else{if(!n)return;n.updateBotPersona(t)}}))],he);const le=e=>`nluxc-prompt-box-${e}`;var ue=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,me=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?pe(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&ue(t,s,r),r};let ge=class extends m{constructor(e,{props:t,eventListeners:s}){super(e,t),this.userEventListeners=s}enableTextInput(e=!0){this.setProp("enableTextInput",e),e&&this.focusTextInput()}focusTextInput(){this.executeDomAction("focusTextInput")}handleEnterKeyPressed(){this.handleSendButtonClick()}handleEscapeKeyPressed(){this.handleTextChange("")}handleSendButtonClick(){if(!this.getProp("textInputValue"))return;const e=this.userEventListeners?.onSubmit;e&&e()}handleTextChange(e){const t=this.userEventListeners?.onTextUpdated;t&&t(e);e!==this.getProp("textInputValue")&&this.setProp("textInputValue",e),""===e?this.setProp("sendButtonStatus","disabled"):this.setProp("sendButtonStatus","enabled")}handleTextInputUpdated(e){const t=e.target;t instanceof HTMLTextAreaElement&&this.handleTextChange(t.value)}resetSendButtonStatus(){""===this.getProp("textInputValue")?this.setProp("sendButtonStatus","disabled"):this.setProp("sendButtonStatus","enabled")}resetTextInput(){this.handleTextChange("")}setSendButtonStatus(e){this.setProp("sendButtonStatus",e)}};me([f("enter-key-pressed")],ge.prototype,"handleEnterKeyPressed",1),me([f("escape-key-pressed")],ge.prototype,"handleEscapeKeyPressed",1),me([f("send-message-clicked")],ge.prototype,"handleSendButtonClick",1),me([f("text-updated")],ge.prototype,"handleTextInputUpdated",1),ge=me([C("prompt-box",(({appendToRoot:e,props:t,compEvent:s})=>{const n=G((e=>{const t="bt-primary-filled "+le("send-button")+" "+("loading"===e.sendButtonStatus?le("send-button-loading"):"")+" "+("disabled"===e.sendButtonStatus?le("send-button-disabled"):"");return`<textarea class="nluxc-textarea ${le("text-input")}" placeholder="${e.placeholder||""}" ${e.enableTextInput?"":'disabled="disabled"'} ${e.autoFocus?'autofocus="autofocus"':""} >${e.textInputValue??""}</textarea><button class="${t}" ${"disabled"===e.sendButtonStatus?'disabled="disabled"':""}><svg fill="currentColor" version="1.1" viewBox="0 0 495 495" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><path d="m164.71 456.69c0 2.966 1.647 5.686 4.266 7.072 2.617 1.385 5.799 1.207 8.245-0.468l55.09-37.616-67.6-32.22v63.232z"/><path d="m492.43 32.443c-1.513-1.395-3.466-2.125-5.44-2.125-1.19 0-2.377 0.264-3.5 0.816l-475.59 233.29c-4.861 2.389-7.937 7.353-7.904 12.783 0.033 5.423 3.161 10.353 8.057 12.689l125.34 59.724 250.62-205.99-219.56 220.79 156.14 74.4c1.918 0.919 4.012 1.376 6.084 1.376 1.768 0 3.519-0.322 5.186-0.977 3.637-1.438 6.527-4.318 7.97-7.956l154.6-390c1.224-3.069 0.426-6.578-2.005-8.814z"/></svg><span class="spinning-loader"></span></button>`})(t));if(!n)throw new p({source:Y("prompt-box","render"),message:"Prompt box could not be rendered"});const o=document.createElement("div");o.append(n),o.className=le("container"),e(o);const[r,i]=F(o,":scope > textarea").on("input",s("text-updated")).on("keydown",(e=>e.shiftKey||"Enter"!==e.key?"Escape"===e.key?(s("escape-key-pressed")(),void e.preventDefault()):void 0:(s("enter-key-pressed")(),void e.preventDefault()))).get(),[a,c]=F(o,":scope > button").on("click",s("send-message-clicked")).get();if(!(a instanceof HTMLButtonElement))throw new Error("Expected a button element");if(!(r instanceof HTMLTextAreaElement))throw new p({source:Y("prompt-box","render"),message:"Expected a textarea element"});return{elements:{textInput:r,sendButton:a},actions:{focusTextInput:()=>d((()=>{r.focus(),r.setSelectionRange(r.value.length,r.value.length)})),updateButtonStatus:e=>{a.disabled="disabled"===e||"loading"===e,a.classList.toggle(le("send-button-loading"),"loading"===e),a.classList.toggle(le("send-button-disabled"),"disabled"===e)}},onDestroy:()=>{i(),c()}}}),(({propName:e,newValue:t,dom:{elements:s,actions:n}})=>{switch(e){case"enableTextInput":s?.textInput instanceof HTMLTextAreaElement&&(s.textInput.disabled=!t),s?.sendButton instanceof HTMLButtonElement&&(s.sendButton.disabled=!t);break;case"sendButtonStatus":["enabled","disabled","loading"].includes(t)&&n?.updateButtonStatus(t);break;case"textInputValue":"string"==typeof t&&s?.textInput instanceof HTMLTextAreaElement&&(s.textInput.value=t)}}))],ge);class Ce{constructor({replay:e}={}){this.buffer=[],this.errorReceived=null,this.isCompleted=!1,this.isReplayObservable=!1,this.subscribers=new Set,this.isReplayObservable=e??!1}complete(){this.subscribers.forEach((e=>e.complete?.())),this.isCompleted=!0}error(e){this.subscribers.forEach((t=>t.error?.(e))),this.isReplayObservable&&(this.errorReceived=e)}next(e){this.subscribers.forEach((t=>t.next(e))),this.isReplayObservable&&this.buffer.push(e)}pipe(...e){let t=this;for(let e=0;e<arguments.length;e++)t=arguments[e](t);return t}reset(){this.subscribers.clear(),this.buffer=[]}subscribe(e){return this.subscribers.add(e),this.isReplayObservable&&this.sendBufferToObserver(e),{unsubscribe:()=>this.unsubscribe(e)}}unsubscribe(e){this.subscribers.delete(e)}sendBufferToObserver(e){this.buffer.forEach((t=>e.next(t))),this.errorReceived?e.error?.(this.errorReceived):this.isCompleted&&e.complete?.()}}const fe="dom/getElement",we=e=>`nluxc-chat-room-${e}`,ye=e=>void 0===e?j:null===e?0:e;var xe=Object.defineProperty,ve=Object.getOwnPropertyDescriptor,be=(e,t,s,n)=>{for(var o,r=n>1?void 0:n?ve(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&xe(t,s,r),r};let ke=class extends m{constructor(e,{containerMaxHeight:t,containerHeight:s,containerMaxWidth:n,containerWidth:o,scrollWhenGenerating:r,streamingAnimationSpeed:i,visible:a=!0,promptBox:d,botPersona:c,userPersona:h,initialConversationContent:l}){super(e,{visible:a,containerMaxHeight:t,containerHeight:s,containerMaxWidth:n,containerWidth:o,scrollWhenGenerating:r,streamingAnimationSpeed:i,botPersona:c,userPersona:h}),this.promptBoxText="";const u=r??ke.defaultScrollWhenGeneratingUserOption;if(this.addConversation(u,ye(i),c,h,l),this.addPromptBox(d?.placeholder,d?.autoFocus),!this.conversation||!this.promptBoxInstance)throw new Error("Conversation is not initialized")}getConversationContentForAdapter(e="max"){return this.conversation.getConversationContentForAdapter(e)}hide(){this.setProp("visible",!1)}messagesContainerClicked(){this.promptBoxInstance?.focusTextInput()}onChatRoomReady(e){this.context.emit("ready",{aiChatProps:this.context.aiChatProps})}setProps(e){e.hasOwnProperty("containerMaxHeight")&&this.setProp("containerMaxHeight",e.containerMaxHeight??void 0),e.hasOwnProperty("containerHeight")&&this.setProp("containerHeight",e.containerHeight??void 0),e.hasOwnProperty("containerMaxWidth")&&this.setProp("containerMaxWidth",e.containerMaxWidth??void 0),e.hasOwnProperty("containerWidth")&&this.setProp("containerWidth",e.containerWidth??void 0),e.hasOwnProperty("scrollWhenGenerating")&&this.conversation?.toggleAutoScrollToStreamingMessage(e.scrollWhenGenerating??!0),e.hasOwnProperty("streamingAnimationSpeed")&&this.conversation?.setStreamingAnimationSpeed(ye(e.streamingAnimationSpeed)),e.hasOwnProperty("botPersona")&&this.conversation?.setBotPersona(e.botPersona??void 0),e.hasOwnProperty("userPersona")&&this.conversation?.setUserPersona(e.userPersona??void 0)}show(){this.setProp("visible",!0)}addConversation(e,t,s,n,o){this.conversation=g(he).withContext(this.context).withProps({scrollWhenGenerating:e,streamingAnimationSpeed:t,botPersona:s,userPersona:n,messages:o}).create(),this.addSubComponent(this.conversation.id,this.conversation,"conversationContainer")}addPromptBox(e,t){this.promptBoxInstance=g(ge).withContext(this.context).withProps({props:{enableTextInput:!0,sendButtonStatus:"disabled",textInputValue:"",placeholder:e,autoFocus:t},eventListeners:{onTextUpdated:e=>this.handlePromptBoxTextChange(e),onSubmit:()=>this.handlePromptBoxSubmit()}}).create(),this.addSubComponent(this.promptBoxInstance.id,this.promptBoxInstance,"promptBoxContainer")}handlePromptBoxSubmit(){const{adapter:e}=this.context,s=(e=>"object"==typeof e&&null!==e&&("function"==typeof e.streamText||"function"==typeof e.fetchText)&&["stream","fetch"].includes(e.dataTransferMode)&&"string"==typeof e.id&&"object"==typeof e.info&&null!==e.info)(e)?e:void 0;(({context:e,promptBoxInstance:s,conversation:n,messageToSend:o,resetPromptBox:r,dataTransferMode:i})=>()=>{const a=n.addMessage("out","static",new Date,o);try{s.enableTextInput(!1),s.setSendButtonStatus("loading");const t=e.adapter;let d,c,h;const l=[];if("function"==typeof t.fetchText&&l.push("fetch"),"function"==typeof t.streamText&&l.push("stream"),0===l.length)throw new Error("ChatAdapter does not support any data transfer mode! The provided adapter must implement either `fetchText()` or `streamText()` methods.");if(i&&!l.includes(i))throw new Error(`ChatAdapter does not support the requested data transfer mode: ${i}. The supported data transfer modes for the provided adapter are: ${l.join(", ")}`);const u=1===l.length?l[0]:"stream",p=i??u,m={aiChatProps:e.aiChatProps,conversationHistory:n.getConversationContentForAdapter(e.aiChatProps?.conversationOptions?.historyPayloadSize)};if("stream"===p){if(!e.adapter.streamText)throw new Error("Streaming mode requested but adapter does not implement streamText");d=new Ce,e.adapter.streamText(o,d,m),h="stream"}else{if(!e.adapter.fetchText)throw new Error("Fetch mode requested but adapter does not implement fetchText");d=void 0,c=e.adapter.fetchText(o,m),h="promise"}const g=n.addMessage("in",h,new Date),C=n.getMessageById(g);if(!C)throw new Error(`Message with id ${g} not found`);if(e.emit("messageSent",o),"promise"===h&&c)c.then((t=>{C.setContent(t),r(!0),n.updateConversationContent({role:"user",message:o}),n.updateConversationContent({role:"ai",message:t}),e.emit("messageReceived",t)})).catch((t=>{C.setErrored(),n.removeMessage(a),n.removeMessage(C.id),r(!1);const s=t?.exceptionId??"NX-AD-001";e.exception(s),e.emit("error",{errorId:s,message:t.message||"An error occurred while sending message via Promise."})}));else{if("stream"!==h||!d)throw new Error(`Message sent with unknown type or data source - Message type: ${h}`);d.subscribe({next:e=>{"string"==typeof e&&C.appendContent(e)},error:t=>{C.setErrored(),n.removeMessage(a),n.removeMessage(C.id),r(!1);const s=t?.exceptionId??"NX-AD-001";e.exception(s),e.emit("error",{errorId:s,message:t.message||"An error occurred while sending message via Observable."})},complete:()=>{C.commitContent(),r(!0),C.content&&(n.updateConversationContent({role:"user",message:o}),n.updateConversationContent({role:"ai",message:C.content}),e.emit("messageReceived",C.content))}})}}catch(e){t(e),r(!1)}})({dataTransferMode:s?s.dataTransferMode:void 0,context:this.context,promptBoxInstance:this.promptBoxInstance,conversation:this.conversation,messageToSend:this.promptBoxText,resetPromptBox:e=>this.resetPromptBox(e)})()}handlePromptBoxTextChange(e){this.promptBoxText=e}resetPromptBox(e=!1){this.promptBoxInstance&&(this.promptBoxInstance.enableTextInput(!0),e&&this.promptBoxInstance.resetTextInput(),this.promptBoxInstance.resetSendButtonStatus(),this.promptBoxInstance.focusTextInput())}};ke.defaultScrollWhenGeneratingUserOption=!0,be([f("messages-container-clicked")],ke.prototype,"messagesContainerClicked",1),be([f("chat-room-ready")],ke.prototype,"onChatRoomReady",1),ke=be([C("chat-room",(({appendToRoot:e,compEvent:t,props:s})=>{const n=G(`<div class="${we("conversation-container")}"></div><div class="${we("prompt-box-container")}"></div>`);if(!n)throw new p({source:Y("chat-room","render"),message:"Chat room could not be rendered"});const o=s.visible??!0,r=document.createElement("div");r.className=we("container"),r.append(n),r.style.display=o?"":"none","number"==typeof s.containerMaxHeight?r.style.maxHeight=`${s.containerMaxHeight}px`:"string"==typeof s.containerMaxHeight&&(r.style.maxHeight=s.containerMaxHeight),"number"==typeof s.containerHeight?r.style.height=`${s.containerHeight}px`:"string"==typeof s.containerHeight&&(r.style.height=s.containerHeight),"number"==typeof s.containerMaxWidth?r.style.maxWidth=`${s.containerMaxWidth}px`:"string"==typeof s.containerMaxWidth&&(r.style.maxWidth=s.containerMaxWidth),"number"==typeof s.containerWidth?r.style.width=`${s.containerWidth}px`:"string"==typeof s.containerWidth&&(r.style.width=s.containerWidth);const[i,a]=F(r,`:scope > .${we("conversation-container")}`).on("click",t("messages-container-clicked")).get(),d=((e,t)=>{if(!t)throw new l({source:fe,message:"A query string must be provided to getElement()"});const s=e.querySelector(t);if(!s)throw new p({source:fe,message:`Could not find element with query "${t}". Make sure the query provided matches an element that exists in the root element.`});if(!(s instanceof HTMLElement))throw new p({source:fe,message:`Element with query "${t}" is not a valid HTMLElement.`});return s})(r,`:scope > .${we("prompt-box-container")}`);return e(r),t("chat-room-ready")(),{elements:{chatRoomContainer:r,promptBoxContainer:d,conversationContainer:i},onDestroy:()=>{a()}}}),(({propName:e,newValue:t,dom:{elements:s,actions:n}})=>{"containerMaxHeight"===e&&s?.chatRoomContainer?s.chatRoomContainer.style.maxHeight="number"==typeof t?`${t}px`:"string"==typeof t?t:"":"containerHeight"===e&&s?.chatRoomContainer?s.chatRoomContainer.style.height="number"==typeof t?`${t}px`:"string"==typeof t?t:"":"containerMaxWidth"===e&&s?.chatRoomContainer?s.chatRoomContainer.style.maxWidth="number"==typeof t?`${t}px`:"string"==typeof t?t:"":"containerWidth"===e&&s?.chatRoomContainer&&(s.chatRoomContainer.style.width="number"==typeof t?`${t}px`:"string"==typeof t?t:"")}))],ke);const Ee=e=>`nluxc-exceptions-box-${e}`;var Te=Object.defineProperty,Pe=Object.getOwnPropertyDescriptor;let Ie=class extends m{constructor(e,t){super(e,t),this.alertShowing=!1,this.alertsQueue=[]}destroy(){super.destroy(),this.alertExpiryTimer&&clearTimeout(this.alertExpiryTimer),this.alertsQueue=[],this.alertShowing=!1,this.alertExpiryTimer=null}removeAllAlerts(){this.alertShowing&&(this.setProp("visible",!1),this.alertShowing=!1),this.alertExpiryTimer&&(clearTimeout(this.alertExpiryTimer),this.alertExpiryTimer=null),this.alertsQueue=[]}showAlert(e,t){this.alertShowing?this.alertsQueue.push({type:e,message:t}):(this.alertShowing=!0,this.setProp("type",e),this.setProp("message",t),this.setProp("visible",!0),this.alertExpiryTimer=setTimeout((()=>{this.setProp("visible",!1),this.alertShowing=!1,setTimeout((()=>{this.checkAlertQueue()}),200)}),3e3))}checkAlertQueue(){if(0===this.alertsQueue.length)return;const e=this.alertsQueue.shift();e&&this.showAlert(e.type,e.message)}};Ie=((e,t,s,n)=>{for(var o,r=n>1?void 0:n?Pe(t,s):t,i=e.length-1;i>=0;i--)(o=e[i])&&(r=(n?o(t,s,r):o(r))||r);return n&&r&&Te(t,s,r),r})([C("exceptions-box",(({props:e,compEvent:t,appendToRoot:s})=>{const n=G((e=>`<div class="${Ee("container")}"><div class="${Ee("exception-container")}" style="display: none"><div class="${Ee("message")}">${e.message??""}</div></div></div>`)(e));if(!(n instanceof HTMLElement))throw new p({source:Y("exceptions-box","render"),message:"Exception alert could not be rendered"});const o=":scope > ."+Ee("exception-container"),r=n.querySelector(o);if(!(r instanceof HTMLElement))throw new p({source:Y("exceptions-box","render"),message:"Exception container element could not be found with selector "+o});const i=":scope > ."+Ee("exception-container")+" > ."+Ee("message"),a=n.querySelector(i);if(!(a instanceof HTMLElement))throw new p({source:Y("exceptions-box","render"),message:"Exception message element could not be found with selector "+i});return"number"==typeof e.containerMaxWidth?n.style.maxWidth=`${e.containerMaxWidth}px`:"string"==typeof e.containerMaxWidth&&(n.style.maxWidth=e.containerMaxWidth),s(n),{elements:{},actions:{hide:()=>{r.style.display="none",a.innerHTML=""},show:()=>{r.style.display=""},setMessage:e=>{a.append(document.createTextNode(e))},setMessageType:e=>{n.classList.remove("error-exception","warning-exception"),n.classList.add(`${e}-exception`)},updateContainerMaxWidth:e=>{n.style.maxWidth="number"==typeof e?`${e}px`:"string"==typeof e?e:""}},onDestroy:()=>{n.remove()}}}),(({propName:e,newValue:t,dom:{elements:s,actions:n}})=>{"visible"===e&&"boolean"==typeof t&&n?t?n.show():n.hide():"message"===e&&"string"==typeof t&&n?n.setMessage(t):"type"===e&&["error","warning"].includes(t)&&n?n.setMessageType(t):"containerMaxWidth"===e&&n&&n.updateContainerMaxWidth(t)}))],Ie);const _e=()=>{const e=a(),t=btoa("componentsRegistered");e&&!0===e[t]||(Object.entries({list:x,"chat-room":ke,"exceptions-box":Ie,conversation:he,"prompt-box":ge,message:se}).forEach((([e,t])=>{r.register(t)})),"object"==typeof e&&(e[t]=!0))},Se={"NX-NT-001":{type:"error",message:"Connection error. Please try again."},"NX-NT-002":{type:"error",message:"Invalid API key. Please update it and try again."},"NX-NT-003":{type:"error",message:"Sorry, cannot call API. HTTP server side error."},"NX-NT-004":{type:"error",message:"Sorry, cannot call API. HTTP client side error."},"NX-AD-001":{type:"error",message:"Failed to load content. Please try again."}};class Le{constructor(){this.emit=(e,...t)=>{this.eventListeners.has(e)&&this.eventListeners.get(e)?.forEach((e=>{"function"==typeof e&&e(...t)}))},this.on=(e,t)=>{this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e)?.add(t)},this.removeAllEventListeners=e=>this.eventListeners.delete(e),this.removeAllEventListenersForAllEvent=()=>this.eventListeners.clear(),this.removeEventListener=(e,t)=>{this.eventListeners.has(e)&&(this.eventListeners.get(e)?.delete(t),this.eventListeners.get(e)?.size||this.eventListeners.delete(e))},this.updateEventListeners=e=>{const t=Object.keys(e);for(const s of t)this.eventListeners.set(s,new Set([e[s]]))},this.eventListeners=new Map}}const Me=class e{constructor(t,s,n,o=null){if(this.chatRoom=null,this.exceptionsBox=null,this.isDestroyed=!1,this.isMounted=!1,this.rootClassName="nluxc-root",this.rootCompId=null,this.rootElement=null,this.theClassName=null,this.theConversationOptions={},this.theInitialConversationContent=null,this.theLayoutOptions={},this.thePersonasOptions={},this.thePromptBoxOptions={},!s)throw new p({source:this.constructor.name,message:"Root component ID is not a valid component name"});this.__context=t,this.rootElement=n,this.rootElementInitialClassName=n.className,this.rootCompId=s,this.chatRoom=null,this.theClassName=o?.className??null,this.theThemeId=o?.themeId??e.defaultThemeId,this.theLayoutOptions=o?.layoutOptions??{},this.theConversationOptions=o?.conversationOptions??{},this.theInitialConversationContent=o?.initialConversation??null,this.thePromptBoxOptions=o?.promptBoxOptions??{},this.thePersonasOptions=o?.personaOptions??{}}get context(){return this.__context}get mounted(){return this.isMounted}get themeId(){return this.theThemeId}destroy(){this.mounted&&this.unmount(),this.chatRoom&&this.chatRoom.destroy(),this.rootElement=null,this.rootElementInitialClassName=null,this.rootCompId=null,this.chatRoom=null,this.isMounted=!1,this.isDestroyed=!0,this.theLayoutOptions={},this.theConversationOptions={},this.thePromptBoxOptions={}}hide(){if(!this.mounted)throw new p({source:this.constructor.name,message:"Renderer is not mounted and cannot be hidden"});this.chatRoom?.hide(),this.exceptionsBox?.removeAllAlerts()}mount(){if(this.isDestroyed)throw new p({source:this.constructor.name,message:"Renderer is destroyed and cannot be mounted"});if(!this.rootCompId||!this.rootElement)throw new p({source:this.constructor.name,message:"Root component or root class is not set"});let e=null,s=null;try{if("chat-room"!==this.rootCompId)throw new p({source:this.constructor.name,message:"Root component is not a chat room"});e=g(ke).withContext(this.context).withProps({visible:!0,botPersona:this.thePersonasOptions?.bot??void 0,userPersona:this.thePersonasOptions?.user??void 0,initialConversationContent:this.theInitialConversationContent??void 0,scrollWhenGenerating:this.theConversationOptions?.scrollWhenGenerating,streamingAnimationSpeed:this.theConversationOptions?.streamingAnimationSpeed,containerMaxHeight:this.theLayoutOptions?.maxHeight||void 0,containerHeight:this.theLayoutOptions?.height||void 0,containerMaxWidth:this.theLayoutOptions?.maxWidth||void 0,containerWidth:this.theLayoutOptions?.width||void 0,promptBox:{placeholder:this.thePromptBoxOptions?.placeholder??void 0,autoFocus:this.thePromptBoxOptions?.autoFocus??void 0}}).create();const n=r.retrieve("exceptions-box")?.model;if(n?s=g(Ie).withContext(this.context).withProps({containerMaxWidth:this.theLayoutOptions?.maxWidth||void 0,message:void 0,visible:!1,type:"error"}).create():t("Exception alert component is not registered! No exceptions will be shown."),!e)throw new p({source:this.constructor.name,message:"Root component failed to instantiate"});if(this.setRootElementClassNames(),s&&s.render(this.rootElement),e.render(this.rootElement),e&&!e.rendered)throw this.rootElement.className=this.rootElementInitialClassName||"",new p({source:this.constructor.name,message:"Root component did not render"});this.chatRoom=e,this.exceptionsBox=s??null,this.isMounted=!0}catch(e){this.rootElement.className=this.rootElementInitialClassName||"",this.renderEx("error",e?.toString()??"Unknown error")}}renderEx(e,s){if(!this.mounted)throw t("Renderer is not mounted and cannot render exceptions"),new p({source:this.constructor.name,message:s});this.exceptionsBox?.showAlert(e,s)}show(){if(!this.mounted)throw new p({source:this.constructor.name,message:"Renderer is not mounted and cannot be shown"});this.chatRoom?.show()}unmount(){if(this.isDestroyed)t("Renderer is destroyed and cannot be unmounted");else{if(!this.chatRoom||!this.rootElement)throw new p({source:this.constructor.name,message:"Root component or root element is not set"});this.context.emit("preDestroy",{aiChatProps:this.context.aiChatProps,conversationHistory:this.chatRoom.getConversationContentForAdapter(this.context.aiChatProps.conversationOptions?.historyPayloadSize)??[]}),this.exceptionsBox&&this.exceptionsBox.destroy(),this.chatRoom.destroy(),this.rootElement&&(this.rootElement.innerHTML="",this.rootElement.className=this.rootElementInitialClassName||""),this.chatRoom=null,this.exceptionsBox=null,this.isMounted=!1}}updateProps(e){if(e.hasOwnProperty("className")){const t=e.className||void 0;t?(this.theClassName&&this.rootElement?.classList.remove(this.theClassName),this.theClassName=t,this.rootElement?.classList.add(t)):this.theClassName&&(this.rootElement?.classList.remove(this.theClassName),this.theClassName=null)}if(e.hasOwnProperty("adapter")&&e.adapter&&this.context.update({adapter:e.adapter}),e.hasOwnProperty("layoutOptions")){const t={};e.layoutOptions?.hasOwnProperty("maxHeight")&&(t.containerMaxHeight=e.layoutOptions.maxHeight),e.layoutOptions?.hasOwnProperty("height")&&(t.containerHeight=e.layoutOptions.height),e.layoutOptions?.hasOwnProperty("maxWidth")&&(t.containerMaxWidth=e.layoutOptions.maxWidth),e.layoutOptions?.hasOwnProperty("width")&&(t.containerWidth=e.layoutOptions.width),this.theLayoutOptions={...this.theLayoutOptions,...e.layoutOptions},this.chatRoom?.setProps(t)}if(e.hasOwnProperty("conversationOptions")&&(this.theConversationOptions=e.conversationOptions??{},this.chatRoom?.setProps({scrollWhenGenerating:e.conversationOptions?.scrollWhenGenerating??void 0,streamingAnimationSpeed:e.conversationOptions?.streamingAnimationSpeed??void 0})),e.hasOwnProperty("promptBoxOptions"),e.hasOwnProperty("syntaxHighlighter"),e.hasOwnProperty("personaOptions")){const t={};e.personaOptions?.hasOwnProperty("bot")&&e.personaOptions.bot!==this.thePersonasOptions?.bot&&(t.botPersona=e.personaOptions?.bot??void 0),e.personaOptions?.hasOwnProperty("user")&&e.personaOptions?.user!==this.thePersonasOptions?.user&&(t.userPersona=e.personaOptions?.user??void 0),this.thePersonasOptions={...this.thePersonasOptions,...e.personaOptions},this.chatRoom?.setProps(t)}}setRootElementClassNames(){if(!this.rootElement)return;this.rootElement.classList.add(this.rootClassName),this.theClassName&&this.rootElement.classList.add(this.theClassName);const e=`nluxc-theme-${this.themeId}`;this.rootElement.classList.add(e)}};Me.defaultThemeId="nova";let Oe=Me;class Ae{constructor(e,s){this.eventManager=new Le,this.nluxInstanceId=c(),this.renderException=e=>{if(!this.mounted||!this.renderer)return null;const s=Se[e];if(!s)return t(`Exception with id '${e}' is not defined`),null;this.renderer.renderEx(s.type,s.message)},this.renderer=null,this.rootCompId="chat-room",this.rootElement=e,this.props=s}get mounted(){return this.renderer?.mounted}hide(){this.mounted&&this.renderer?.hide()}mount(){if(this.mounted)return;const e=((e,t,s)=>{const n={...e,update:e=>{Object.assign(n,e)},emit:(e,...t)=>{s(e,...t)},get aiChatProps(){return t()}};return n})({instanceId:this.nluxInstanceId,exception:this.renderException,adapter:this.props.adapter,syntaxHighlighter:this.props.syntaxHighlighter},(()=>({...this.props,conversationOptions:this.props.conversationOptions&&Object.keys(this.props.conversationOptions).length>0?this.props.conversationOptions:void 0,promptBoxOptions:this.props.promptBoxOptions&&Object.keys(this.props.promptBoxOptions).length>0?this.props.promptBoxOptions:void 0,layoutOptions:this.props.layoutOptions&&Object.keys(this.props.layoutOptions).length>0?this.props.layoutOptions:void 0,personaOptions:this.props.personaOptions&&Object.keys(this.props.personaOptions).length>0?this.props.personaOptions:void 0})),this.eventManager.emit);this.renderer=new Oe(e,this.rootCompId,this.rootElement,this.props),this.renderer.mount()}on(e,t){this.eventManager.on(e,t)}removeAllEventListeners(e){this.eventManager.removeAllEventListeners(e)}removeAllEventListenersForAllEvent(){this.eventManager.removeAllEventListenersForAllEvent()}removeEventListener(e,t){this.eventManager.removeEventListener(e,t)}show(){this.mounted&&this.renderer?.show()}unmount(){this.mounted&&(this.renderer?.unmount(),this.renderer=null)}updateProps(e){this.renderer?.updateProps(e),this.props={...this.props,...e},e.events&&(this.props.events=e.events,this.eventManager.updateEventListeners(e.events))}}class $e{constructor(){this.theAdapter=null,this.theAdapterBuilder=null,this.theAdapterType=null,this.theClassName=null,this.theConversationOptions=null,this.theInitialConversation=null,this.theLayoutOptions=null,this.thePersonasOptions=null,this.thePromptBoxOptions=null,this.theSyntaxHighlighter=null,this.theThemeId=null,this.controller=null,this.unregisteredEventListeners=new Map}get mounted(){return this.controller?.mounted??!1}hide(){if(!this.controller)throw new p({source:this.constructor.name,message:"Unable to hide. nlux is not mounted."});this.controller.hide()}mount(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to create nlux instance. nlux is already mounted. Make sure to call `unmount()` before mounting again."});const t=this.theAdapter&&"instance"===this.theAdapterType?this.theAdapter:"builder"===this.theAdapterType&&this.theAdapterBuilder?this.theAdapterBuilder:null;if(!t)throw new u({source:this.constructor.name,message:"Unable to create nlux instance. ChatAdapter is not properly set. You should call `withAdapter(adapter)` method before mounting nlux."});_e(),e.innerHTML="";const s=new Ae(e,{themeId:this.theThemeId??void 0,adapter:t,className:this.theClassName??void 0,initialConversation:this.theInitialConversation??void 0,syntaxHighlighter:this.theSyntaxHighlighter??void 0,layoutOptions:this.theLayoutOptions??{},conversationOptions:this.theConversationOptions??{},promptBoxOptions:this.thePromptBoxOptions??{},personaOptions:this.thePersonasOptions??{}});for(const[e,t]of this.unregisteredEventListeners.entries())for(const n of t)s.on(e,n);if(s.mount(),!s.mounted)throw new p({source:this.constructor.name,message:"AiChat root component did not render."});this.controller=s,this.unregisteredEventListeners.clear()}on(e,t){return this.controller?(this.controller.on(e,t),this):(this.unregisteredEventListeners.has(e)||this.unregisteredEventListeners.set(e,new Set),this.unregisteredEventListeners.get(e)?.add(t),this)}removeAllEventListeners(e){if(!e)return this.controller?.removeAllEventListenersForAllEvent(),void this.unregisteredEventListeners.clear();this.controller?.removeAllEventListeners(e),this.unregisteredEventListeners.get(e)?.clear()}removeEventListener(e,t){this.controller?.removeEventListener(e,t),this.unregisteredEventListeners.get(e)?.delete(t)}show(){if(!this.controller)throw new p({source:this.constructor.name,message:"Unable to show. nlux is not mounted."});this.controller.show()}unmount(){if(this.controller){if(this.controller.unmount(),this.controller.mounted)throw new p({source:this.constructor.name,message:"Unable to unmount. Root component did not unmount."});this.controller=null,this.unregisteredEventListeners.clear()}}updateProps(e){if(!this.controller)throw new p({source:this.constructor.name,message:"Unable to update props. nlux is not mounted."});this.controller.updateProps(e)}withAdapter(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set adapter. nlux is already mounted."});if(this.theAdapterBuilder||this.theAdapter)throw new l({source:this.constructor.name,message:"Unable to change config. A adapter or adapter builder was already set."});if("object"!=typeof e||null===e)throw new l({source:this.constructor.name,message:"Unable to set adapter. Invalid adapter or adapter-builder type."});const t=e;if("function"==typeof t.create)return this.theAdapterType="builder",this.theAdapterBuilder=t.create(),this;if("function"==typeof t.fetchText||"function"==typeof t.streamText)return this.theAdapterType="instance",this.theAdapter=t,this;throw new l({source:this.constructor.name,message:"Unable to set adapter. Invalid adapter or adapter-builder implementation! When an `ChatAdapterBuilder` is provided, it must implement either `create()` method that returns an ChatAdapter instance. When an ChatAdapter instance is provided, must implement `fetchText()` and/or `streamText()` methods. None of the above were found."})}withClassName(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set class name. nlux is already mounted."});if(this.theClassName)throw new l({source:this.constructor.name,message:"Unable to change config. A class name was already set."});return this.theClassName=e,this}withConversationOptions(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set conversation options. nlux is already mounted."});if(this.theConversationOptions)throw new l({source:this.constructor.name,message:"Unable to change config. Conversation options were already set."});return this.theConversationOptions={...e},this}withInitialConversation(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set conversation history. nlux is already mounted."});if(this.theInitialConversation)throw new l({source:this.constructor.name,message:"Unable to change config. Conversation history was already set."});return this.theInitialConversation=[...e],this}withLayoutOptions(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set layout options. nlux is already mounted."});if(this.theLayoutOptions)throw new l({source:this.constructor.name,message:"Unable to change config. Layout options were already set."});return this.theLayoutOptions={...e},this}withPersonaOptions(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set personaOptions. nlux is already mounted."});if(this.thePersonasOptions)throw new l({source:this.constructor.name,message:"Unable to change config. Personas were already set."});return this.thePersonasOptions={...e},this}withPromptBoxOptions(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set prompt box options. nlux is already mounted."});if(this.thePromptBoxOptions)throw new l({source:this.constructor.name,message:"Unable to change config. Prompt box options were already set."});return this.thePromptBoxOptions={...e},this}withSyntaxHighlighter(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set code highlighter. nlux is already mounted."});if(this.theSyntaxHighlighter)throw new l({source:this.constructor.name,message:"Unable to change config. Code highlighter was already set."});return this.theSyntaxHighlighter=e,this}withTheme(e){if(this.mounted)throw new l({source:this.constructor.name,message:"Unable to set theme. nlux is already mounted."});return this.theThemeId=e,this}}class Be{constructor(e){this.actionToPerformWhenIdle="none",this.itemIds=new Set,this.status="idle",this.theContextId=null,this.updateQueueByItemId=new Map,this.dataAdapter=e}get contextId(){return this.theContextId}async createContext(e){if("destroyed"===this.status)return{success:!1,error:"The context has been destroyed"};const t=e??null;if(this.itemIds.clear(),null!==t){Object.keys(t).forEach((e=>{this.itemIds.add(e)}))}this.actionToPerformWhenIdle="none";try{const e=await this.dataAdapter.create(t??{});return e.success?(this.theContextId=e.contextId,{success:!0,contextId:e.contextId}):{success:!1,error:"Failed to set the context"}}catch(e){return{success:!1,error:`${e}`}}}async destroy(){return"destroyed"===this.status?(t("Context.DataSyncService.destroy() called on a state that has already been destroyed"),{success:!0}):("updating"!==this.status||this.contextId||t("Context.DataSyncService.destroy() called with no contextId!"),this.contextId&&(this.status="updating",await this.dataAdapter.discard(this.contextId)),this.status="destroyed",this.theContextId=null,this.updateQueueByItemId.clear(),this.actionToPerformWhenIdle="none",{success:!0})}async flush(){if(!this.contextId)throw new Error("Context not initialized");if("updating"===this.status)return void(this.actionToPerformWhenIdle="flush");this.status="updating";const e=this.updateQueueByItemId.keys(),s=[],n=[];for(const t of e){const e=this.updateQueueByItemId.get(t);e&&("delete"!==e.operation?["set","update"].includes(e.operation)&&s.push(t):n.push(t))}const o=s.reduce(((e,t)=>{const s=this.updateQueueByItemId.get(t);return s?("set"===s.operation&&(e[t]={value:s.data,description:s.description}),"update"!==s.operation||void 0===s.data&&void 0===s.description||(e[t]={value:s.data,description:s.description}),e):e}),{});if(Object.keys(o).length>0){Object.keys(o).forEach((e=>{this.updateQueueByItemId.delete(e)}));try{await this.dataAdapter.updateItems(this.contextId,o)}catch(e){t(`Failed to update context data: ${e}`),Object.keys(o).forEach((e=>{const t=o[e];t&&this.updateQueueByItemId.set(e,{operation:"update",data:t.value,description:t.description})}))}}if(n.length>0){n.forEach((e=>{this.itemIds.delete(e),this.updateQueueByItemId.delete(e)}));try{await this.dataAdapter.removeItems(this.contextId,n)}catch(e){t(`Failed to delete context data: ${e}`),n.forEach((e=>{this.itemIds.add(e),this.updateQueueByItemId.set(e,{operation:"delete"})}))}}await this.backToIdle()}hasActiveItemWithId(e){return this.itemIds.has(e)&&(!this.updateQueueByItemId.has(e)||"delete"!==this.updateQueueByItemId.get(e)?.operation)}hasItemWithId(e){return this.itemIds.has(e)}removeItem(e){if("destroyed"===this.status)throw new Error("The context has been destroyed");if(!this.contextId)throw new Error("Context not initialized");if(!this.itemIds.has(e))throw new Error("Item not found");this.updateQueueByItemId.set(e,{operation:"delete"})}async resetContextData(e){const s=this.contextId;if(this.itemIds.clear(),this.updateQueueByItemId.clear(),"updating"!==this.status){if(!s)return t("resetContextData() called with no contextId!"),void await this.backToIdle();try{this.status="updating",await this.dataAdapter.resetItems(s,e)}catch(e){t(`Failed to reset context data: ${e}`)}if(this.updateQueueByItemId.clear(),e){this.itemIds.clear();Object.keys(e).forEach((e=>{this.itemIds.add(e)}))}else this.itemIds.clear();await this.backToIdle()}else this.actionToPerformWhenIdle="reset"}setItemData(e,t,s){if("destroyed"===this.status)throw new Error("The context has been destroyed");this.updateQueueByItemId.set(e,{operation:"set",description:t,data:s}),this.itemIds.add(e)}updateItemData(e,t,s){if("destroyed"===this.status)throw new Error("The context has been destroyed");if(void 0===s&&void 0===t)return;const n=this.updateQueueByItemId.get(e);if("delete"===n?.operation)throw new Error("Item has been deleted");const o=s??n?.data??void 0,r=t??n?.description??void 0;this.updateQueueByItemId.set(e,{operation:"update",data:o,description:r})}async backToIdle(){this.status="idle";const e=this.actionToPerformWhenIdle;this.actionToPerformWhenIdle="none","flush"!==e?"reset"!==e||await this.resetContextData():await this.flush()}}class De{constructor(e,t){this.actionToPerformWhenIdle="none",this.status="idle",this.taskCallbacks=new Map,this.tasks=new Set,this.updateQueueByTaskId=new Map,this.contextId=e,this.adapter=t}canRunTask(e){return this.taskCallbacks.has(e)}async destroy(){return"destroyed"===this.status?(t("Context.TasksService.destroy() called on a state that has already been destroyed"),{success:!0}):(this.status="updating",await this.unregisterAllTasks(),this.status="destroyed",this.updateQueueByTaskId.clear(),this.tasks.clear(),{success:!0})}async flush(){if("updating"===this.status)return void(this.actionToPerformWhenIdle="flush");const e=this.updateQueueByTaskId.keys(),s=[],n=[],o=[];for(const t of e){const e=this.updateQueueByTaskId.get(t);e&&("delete"!==e.operation?"set"!==e.operation?"update"!==e.operation||n.push(t):s.push(t):o.push(t))}if(0===s.length&&0===n.length&&0===o.length)return;this.status="updating";const r={...this.buildUpdateObject(s),...this.buildUpdateObject(n)};if(Object.keys(r).length>0)try{const e=await this.adapter.updateTasks(this.contextId,r);if(e.success)for(const e of Object.keys(r)){const t=this.updateQueueByTaskId.get(e);t&&"set"===t.operation&&(this.taskCallbacks.set(e,t.callback),this.updateQueueByTaskId.delete(e))}else t(`Context.TasksService.flush() failed to register tasks for context ID ${this.contextId}\nError: ${e.error}`)}catch(e){t(`Context.TasksService.flush() failed to register tasks for context ID ${this.contextId}\nError: ${e}`)}if(o.length>0)try{const e=await this.adapter.removeTasks(this.contextId,o);if(e.success)for(const e of o)this.taskCallbacks.delete(e),this.updateQueueByTaskId.delete(e);else t(`Context.TasksService.flush() failed to unregister tasks for context ID ${this.contextId}\nError: ${e.error}`)}catch(e){t(`Context.TasksService.flush() failed to unregister tasks for context ID ${this.contextId}\nError: ${e}`)}await this.backToIdle()}hasTask(e){return this.tasks.has(e)}async registerTask(e,t,s,n){if("destroyed"===this.status)throw new Error("Context has been destroyed");if(this.tasks.has(e))throw new Error(`A task with ID '${e}' already exists. Task IDs must be unique.`);this.updateQueueByTaskId.set(e,{operation:"set",description:t,paramDescriptions:n||[],callback:s}),this.tasks.add(e)}async resetContextData(){const e=this.contextId;if(this.tasks.clear(),this.taskCallbacks.clear(),this.updateQueueByTaskId.clear(),"updating"!==this.status){if(!e)return t("resetContextData() called with no contextId!"),void await this.backToIdle();try{this.status="updating",await this.unregisterAllTasks()}catch(e){t(`Failed to reset context data: ${e}`)}await this.backToIdle()}else this.actionToPerformWhenIdle="reset"}async runTask(e,t){if("destroyed"===this.status)throw new Error("Context has been destroyed");if(!this.tasks.has(e))return{success:!1,error:`Task with ID ${e} not found`};const s=this.taskCallbacks.get(e);if(!s)return{success:!1,error:`The task with ID '${e}' has no callback. This is potential due to failed registration.`};try{return{success:!0,result:s(...t??[])}}catch(e){return{success:!1,error:`${e}`}}}async unregisterAllTasks(){if(0===this.tasks.size)return{success:!0};const e=await this.adapter.resetTasks(this.contextId);return e.success&&(this.tasks.clear(),this.taskCallbacks.clear(),this.updateQueueByTaskId.clear()),e}async unregisterTask(e){if("destroyed"===this.status)throw new Error("Context has been destroyed");return this.tasks.has(e)?(this.tasks.delete(e),this.taskCallbacks.delete(e),this.updateQueueByTaskId.set(e,{operation:"delete"}),{success:!0}):{success:!0}}async updateTaskCallback(e,t){if("destroyed"===this.status)throw new Error("The context has been destroyed");if(!this.tasks.has(e))throw new Error(`Task with ID ${e} not found`);this.taskCallbacks.set(e,t)}async updateTaskDescription(e,t){if("destroyed"===this.status)throw new Error("The context has been destroyed");if(!this.tasks.has(e))throw new Error(`Task with ID ${e} not found`);const s=this.updateQueueByTaskId.get(e);if(s)if("update"!==s.operation){const s={operation:"update",description:t};this.updateQueueByTaskId.set(e,s)}else s.description=t;else this.updateQueueByTaskId.set(e,{operation:"update",description:t})}async updateTaskParamDescriptions(e,t){if("destroyed"===this.status)throw new Error("The context has been destroyed");if(!this.tasks.has(e))throw new Error(`Task with ID ${e} not found`);const s=this.updateQueueByTaskId.get(e);if(s)if("update"!==s.operation){const s={operation:"update",paramDescriptions:t};this.updateQueueByTaskId.set(e,s)}else s.paramDescriptions=t;else this.updateQueueByTaskId.set(e,{operation:"update",paramDescriptions:t})}async backToIdle(){this.status="idle";const e=this.actionToPerformWhenIdle;this.actionToPerformWhenIdle="none","flush"!==e?"reset"!==e||await this.unregisterAllTasks():await this.flush()}buildUpdateObject(e){return e.reduce(((e,t)=>{const s=this.updateQueueByTaskId.get(t);if(!s)return e;if("set"===s.operation&&(e[t]={description:s.description,paramDescriptions:s.paramDescriptions}),"update"===s.operation&&(void 0!==s.description||void 0!==s.paramDescriptions)){const n={};void 0!==s.description&&(n.description=s.description),void 0!==s.paramDescriptions&&(n.paramDescriptions=s.paramDescriptions),e[t]=n}return e}),{})}}class Re{constructor(){this.destroy=async()=>("destroyed"===this.theStatus||(this.theStatus="destroyed",await Promise.all([this.theDataSyncService?.destroy(),this.theTasksService?.destroy()]),this.theDataSyncService=null,this.theTasksService=null,this.theDataAdapter=null,this.theTasksAdapter=null),{success:!0}),this.flush=async()=>{try{await(this.theDataSyncService?.flush())}catch(e){return{success:!1,error:"Failed to flush context data"}}try{await(this.theTasksService?.flush())}catch(e){return{success:!1,error:"Failed to flush context tasks"}}return{success:!0}},this.initialize=async e=>{if("initializing"===this.theStatus)return t(`${this.constructor.name}.initialize() called while context is still initializing! You cannot initialize twice at the same time. Use ${this.constructor.name}.status or await ${this.constructor.name}.initialize() to make sure that the context is not initializing before calling this method.`),{success:!1,error:"Context is still initializing! Use AiContext.status to check the context status before calling this method."};if("syncing"===this.theStatus)return t(`${this.constructor.name}.initialize() called on an already initialized context! Use ${this.constructor.name}.status to check the context status before calling this method. `),{success:!1,error:"Context already initialized! Use AiContext.status to check the context status before calling this method."};if("destroyed"===this.theStatus)return t(`${this.constructor.name}.initialize() called on destroyed context! Use ${this.constructor.name}.status to check the context status before calling this method. When the context is destroyed, it cannot be used anymore and you should create a new context.`),{success:!1,error:"Context has been destroyed"};if("error"===this.theStatus)return t(`${this.constructor.name}.initialize() called on a context in error state! Use ${this.constructor.name}.status to check the context status before calling this method. When the context is in error state, it cannot be used anymore and you should create a new context.`),{success:!1,error:"Context is in error state"};if(!this.theDataAdapter)return t(`Adapter not set! You must set the adapter before initializing the context. Use ${this.constructor.name}.withAdapter() to set the adapter before calling this method.`),{success:!1,error:"Adapter not set"};this.theStatus="initializing",this.theDataSyncService=new Be(this.theDataAdapter);try{const s=await this.theDataSyncService.createContext(e);return"destroyed"===this.status?(s.success&&await(this.theDataSyncService?.resetContextData()),{success:!1,error:"Context has been destroyed"}):s.success?this.contextId?(this.theStatus="syncing",this.theTasksAdapter?this.theTasksService=new De(this.contextId,this.theTasksAdapter):t("Initializing nlux AiContext without tasks adapter. The context will not handle registering and executing tasks by AI. If you want to use tasks triggered by AI, you should provide an adapter that implements ContextAdapter interface [type ContextAdapter = ContextDataAdapter & ContextTasksAdapter]"),{success:!0,contextId:s.contextId}):(this.theStatus="error",{success:!1,error:"Failed to obtain context ID"}):(this.theStatus="error",{success:!1,error:"Failed to initialize context"})}catch(e){return this.theStatus="error",{success:!1,error:`${e}`}}},this.observeState=(e,s,n)=>{if("idle"!==this.theStatus)if("initializing"!==this.theStatus){if("destroyed"!==this.theStatus)return this.theDataSyncService?.setItemData(e,s,n??null),{setData:t=>{this.theDataSyncService?.updateItemData(e,void 0,t)},setDescription:t=>{this.theDataSyncService?.updateItemData(e,t,void 0)},discard:()=>{this.theDataSyncService?.removeItem(e)}};t(`${this.constructor.name}.observeState() called on destroyed context! Use ${this.constructor.name}.status to check the context status before calling this method. When the context is destroyed, it cannot be used anymore and you should create a new context.`)}else t(`${this.constructor.name}.observeState() called while context is still initializing! You cannot observe state items while the context is initializing. Use ${this.constructor.name}.status or await ${this.constructor.name}.initialize() to make sure that the context is not initializing before calling this method.`);else t(`${this.constructor.name}.observeState() called on idle context! Use ${this.constructor.name}.status to check the context status before calling this method. Use ${this.constructor.name}.initialize() to initialize the context when it is not initialized.`)},this.registerTask=(e,s,n,o)=>{if("idle"===this.theStatus)return void t(`${this.constructor.name}.registerTask() called on idle context! Use ${this.constructor.name}.status to check the context status before calling this method. Use ${this.constructor.name}.initialize() to initialize the context when it is not initialized.`);if(!this.theTasksService)return void t(`${this.constructor.name}.registerTask() called on a context that has does not have tasks service! You should use an adapter that implements ContextTasksAdapter interface in order to register tasks. Use ${this.constructor.name}.withAdapter() to set the right adapter before calling this method.`);if("destroyed"===this.theStatus)return void t(`${this.constructor.name}.registerTask() called on destroyed context! Use ${this.constructor.name}.status to check the context status before calling this method. When the context is destroyed, it cannot be used anymore and you should create a new context.`);let r="updating";if(!this.theTasksService.hasTask(e))return this.theTasksService.registerTask(e,s,n,o).then((()=>{"updating"===r&&(r="set")})).catch((s=>{t(`${this.constructor.name}.registerTask() failed to register task '${e}'!\nThe task will be marked as deleted and will not be updated anymore.`),"updating"===r&&(r="deleted",this.unregisterTask(e))})),{discard:()=>{r="deleted",this.unregisterTask(e)},setDescription:t=>{if("deleted"===r)throw new Error("Task has been deleted");r="updating",this.theTasksService?.updateTaskDescription(e,t).then((()=>{"updating"===r&&(r="set")})).catch((e=>{"updating"===r&&(r="set")}))},setCallback:t=>{if("deleted"===r)throw new Error("Task has been deleted");r="updating",this.theTasksService?.updateTaskCallback(e,t).then((()=>{"updating"===r&&(r="set")})).catch((e=>{"updating"===r&&(r="set")}))},setParamDescriptions:t=>{if("deleted"===r)throw new Error("Task has been deleted");r="updating",this.theTasksService?.updateTaskParamDescriptions(e,t).then((()=>{"updating"===r&&(r="set")})).catch((e=>{"updating"===r&&(r="set")}))}};console.warn(`${this.constructor.name}.registerTask() called with existing taskId: ${e}! It's only possible to register a task once. Use ${this.constructor.name}.hasTask() to check if the task already exists. Use ${this.constructor.name}.registerTask() with a different taskId if you want to register a different task.`)},this.reset=async e=>{if(!this.theDataSyncService)return t(`${this.constructor.name}.reset() called on a state that has not been initialized! Use ${this.constructor.name}.initialize() to initialize the context before attempting any reset.`),{success:!1,error:"Context has not been initialized"};try{return await(this.theDataSyncService?.resetContextData(e)),await(this.theTasksService?.resetContextData()),this.theStatus="syncing",{success:!0}}catch(e){return this.theStatus="error",{success:!1,error:`${e}`}}},this.runTask=async(e,s)=>this.theTasksService?this.theTasksService.runTask(e,s):(t(`${this.constructor.name}.runTask() called on a state that has not been initialized! Use ${this.constructor.name}.initialize() to initialize the context before attempting any task execution.`),Promise.resolve({success:!1,error:"Context has not been initialized with tasks service. An adapter that implements ContextTasksAdapter interface should be provided to the context, and the context should be initialized before running any tasks."})),this.withAdapter=e=>{if(this.theDataAdapter)throw new Error("Adapter already set");const t="function"==typeof e?.build;this.theDataAdapter=t?e.build():e;const s=(e=>!(!e||"function"!=typeof e.resetTasks||"function"!=typeof e.updateTasks||"function"!=typeof e.removeTasks)&&e)(this.theDataAdapter);return s&&(this.theTasksAdapter=s),this},this.withDataSyncOptions=e=>{if(this.theDataSyncOptions)throw new Error("Data sync options already set");return this.theDataSyncOptions={...e},this},this.theDataAdapter=null,this.theDataSyncOptions=null,this.theDataSyncService=null,this.theStatus="idle",this.theTasksAdapter=null,this.theTasksService=null,this.unregisterTask=e=>this.theTasksService?this.theTasksService.unregisterTask(e):(t(`${this.constructor.name}.unregisterTask() called on a state that has not been initialized! Use ${this.constructor.name}.initialize() to initialize the context before attempting any task unregistration.`),Promise.resolve({success:!1,error:"Context has not been initialized"}))}get contextId(){return this.theDataSyncService?.contextId??null}get status(){return this.theStatus}hasItem(e){return this.theDataSyncService?.hasItemWithId(e)??!1}hasRunnableTask(e){return this.theTasksService?.canRunTask(e)??!1}hasTask(e){return this.theTasksService?.hasTask(e)??!1}}e.AiChat=$e,e.NluxConfigError=class extends h{},e.NluxError=h,e.NluxRenderingError=p,e.NluxUsageError=l,e.NluxValidationError=u,e.Observable=Ce,e.createAiChat=()=>new $e,e.createAiContext=()=>new Re,e.createMdStreamRenderer=Q,e.debug=(...e)=>{},e.predefinedContextSize={"1k":1e3,"10k":1e4,"100k":1e5,"1mb":1e6,"10mb":1e7},e.uid=c,e.warn=t,e.warnOnce=n}));
